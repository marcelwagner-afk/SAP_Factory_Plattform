<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Implementation Factory - Complete Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: linear-gradient(135deg, #0c1222 0%, #1a1f35 50%, #0c1222 100%); }
        .card { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(71, 85, 105, 0.3); backdrop-filter: blur(10px); }
        .card-highlight { background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-color: rgba(59, 130, 246, 0.3); }
        .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.2); }
        .glow-green { box-shadow: 0 0 30px rgba(34, 197, 94, 0.2); }
        .glow-purple { box-shadow: 0 0 30px rgba(139, 92, 246, 0.2); }
        .glow-amber { box-shadow: 0 0 30px rgba(245, 158, 11, 0.2); }
        .nav-tab { transition: all 0.3s; border: 1px solid transparent; }
        .nav-tab:hover { background: rgba(59, 130, 246, 0.1); }
        .nav-tab.active { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2)); border-color: rgba(59, 130, 246, 0.4); }
        .yaml-editor { background: #0d1117; border: 1px solid #30363d; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.5; }
        .yaml-editor:focus { outline: none; border-color: #58a6ff; }
        .progress-bar { background: linear-gradient(90deg, #3b82f6, #8b5cf6, #22c55e); background-size: 200% 100%; animation: shimmer 2s ease infinite; }
        @keyframes shimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        .log-entry { border-left: 3px solid transparent; transition: all 0.2s; }
        .log-entry:hover { background: rgba(59, 130, 246, 0.1); }
        .log-info { border-left-color: #3b82f6; }
        .log-success { border-left-color: #22c55e; }
        .log-warning { border-left-color: #f59e0b; }
        .log-error { border-left-color: #ef4444; }
        .upload-zone { border: 2px dashed rgba(148, 163, 184, 0.3); transition: all 0.3s; }
        .upload-zone:hover { border-color: rgba(59, 130, 246, 0.6); background: rgba(59, 130, 246, 0.05); }
        .upload-zone.dragover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .data-flow { animation: flow 2s ease-in-out infinite; }
        @keyframes flow { 0%, 100% { transform: translateX(0); opacity: 0.5; } 50% { transform: translateX(10px); opacity: 1; } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .artifact-tree { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .json-key { color: #7dd3fc; }
        .json-string { color: #86efac; }
        .json-number { color: #fcd34d; }
        .json-boolean { color: #c4b5fd; }
        .module-card { transition: all 0.3s; }
        .module-card:hover { transform: translateY(-2px); }
        /* Bot Panel Styles */
        .bot-panel-open { transform: translateX(0) !important; }
        .bot-message { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)); border: 1px solid rgba(59, 130, 246, 0.2); }
        .user-message { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
        .bot-card { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.4); }
        .bot-fade-in { animation: botFadeIn 0.3s ease-out; }
        @keyframes botFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">

<div id="app" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-72 border-r border-slate-700/50 flex flex-col">
        <!-- Logo -->
        <div class="p-6 border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <i data-lucide="factory" class="w-7 h-7"></i>
                </div>
                <div>
                    <div class="font-bold text-xl">SAP Factory</div>
                    <div class="text-xs text-slate-400">S/4HANA Implementation Platform</div>
                </div>
            </div>
        </div>

        <!-- Project Info -->
        <div class="p-4 border-b border-slate-700/50">
            <div class="card rounded-lg p-3">
                <div class="text-xs text-slate-400 mb-1">Aktuelles Projekt</div>
                <div id="project-name" class="font-semibold text-sm">Mustermann GmbH</div>
                <div class="text-xs text-slate-500">Template: RETAIL_CORE_DE</div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-1 overflow-auto">
            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 px-2">Übersicht</div>
            <button onclick="setTab('dashboard')" id="tab-dashboard" class="nav-tab active w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="setTab('architecture')" id="tab-architecture" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="git-branch" class="w-4 h-4"></i>
                <span>Architektur</span>
            </button>

            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 px-2 mt-4">Konfiguration</div>
            <button onclick="setTab('config')" id="tab-config" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="file-code" class="w-4 h-4"></i>
                <span>YAML Editor</span>
            </button>
            <button onclick="setTab('templates')" id="tab-templates" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="table" class="w-4 h-4"></i>
                <span>Excel Templates</span>
            </button>

            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 px-2 mt-4">Migration</div>
            <button onclick="setTab('migration')" id="tab-migration" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="arrow-right-left" class="w-4 h-4"></i>
                <span>ECC → S/4HANA</span>
            </button>

            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 px-2 mt-4">Ausführung</div>
            <button onclick="setTab('execution')" id="tab-execution" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="play-circle" class="w-4 h-4"></i>
                <span>Run starten</span>
            </button>
            <button onclick="setTab('artifacts')" id="tab-artifacts" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="archive" class="w-4 h-4"></i>
                <span>Artefakte</span>
            </button>
            <button onclick="setTab('downloads')" id="tab-downloads" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>ABAP & Transport</span>
            </button>

            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 px-2 mt-4">API</div>
            <button onclick="setTab('api')" id="tab-api" class="nav-tab w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left text-sm">
                <i data-lucide="terminal" class="w-4 h-4"></i>
                <span>API Explorer</span>
            </button>
        </nav>

        <!-- Status -->
        <div class="p-4 border-t border-slate-700/50">
            <div class="flex items-center gap-2 text-xs">
                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                <span class="text-slate-400">Source: ECC 6.0</span>
            </div>
            <div class="flex items-center gap-2 text-xs mt-1">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span class="text-slate-400">Target: S/4HANA 2023</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
        <!-- Header -->
        <header class="sticky top-0 z-10 backdrop-blur-md bg-slate-900/80 border-b border-slate-700/50 px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="page-title" class="text-2xl font-bold">Dashboard</h1>
                    <p id="page-subtitle" class="text-slate-400 text-sm">Übersicht der SAP Implementation Factory</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="run-indicator" class="hidden items-center gap-2 px-4 py-2 rounded-lg bg-blue-500/20 border border-blue-500/30">
                        <div class="w-2 h-2 rounded-full bg-blue-500 pulse"></div>
                        <span class="text-sm text-blue-300" id="run-indicator-text">Run aktiv</span>
                    </div>
                    <button onclick="startNewRun()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg font-medium hover:opacity-90 transition flex items-center gap-2">
                        <i data-lucide="rocket" class="w-4 h-4"></i>
                        Neuer Run
                    </button>
                    <button onclick="toggleBotPanel()" id="bot-toggle" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition relative">
                        <i data-lucide="bot" class="w-5 h-5 text-blue-400"></i>
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900"></span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="p-8" id="content-area">
            <!-- Wird dynamisch befüllt -->
        </div>
    </main>

    <!-- Bot Chat Panel -->
    <aside id="bot-panel" class="fixed right-0 top-0 h-full w-96 bg-slate-900 border-l border-slate-700/50 transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <!-- Bot Header -->
        <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <i data-lucide="bot" class="w-5 h-5"></i>
                </div>
                <div>
                    <div class="font-semibold">SAP Factory Bot</div>
                    <div class="text-xs text-green-400 flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                        Online
                    </div>
                </div>
            </div>
            <button onclick="toggleBotPanel()" class="p-2 rounded-lg hover:bg-slate-800 text-slate-400">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="bot-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Messages rendered here -->
        </div>

        <!-- Quick Actions -->
        <div id="bot-quick-actions" class="px-4 py-2 border-t border-slate-700/50 flex gap-2 overflow-x-auto">
            <!-- Quick action buttons -->
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-slate-700/50">
            <!-- Drop Zone Indicator -->
            <div id="bot-drop-zone" class="hidden mb-3 p-4 border-2 border-dashed border-blue-500 rounded-lg bg-blue-500/10 text-center">
                <i data-lucide="upload" class="w-8 h-8 mx-auto text-blue-400 mb-2"></i>
                <p class="text-blue-400 text-sm">Excel-Dateien hier ablegen</p>
            </div>
            <div class="flex gap-2">
                <input type="file" id="bot-file-input" multiple accept=".xlsx,.xls,.csv" class="hidden" onchange="handleBotFileUpload(event)">
                <button onclick="document.getElementById('bot-file-input').click()" class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300" title="Dateien hochladen">
                    <i data-lucide="paperclip" class="w-4 h-4"></i>
                </button>
                <input type="text" id="bot-input" placeholder="Nachricht eingeben..."
                    class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:border-blue-500 focus:outline-none text-sm"
                    onkeypress="if(event.key==='Enter')sendBotMessage()">
                <button onclick="sendBotMessage()" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-500">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>
</div>

<script>
// ============================================================================
// STATE & CONFIG
// ============================================================================
var state = {
    activeTab: 'dashboard',
    currentRun: null,
    runStatus: 'idle',
    runProgress: 0,
    currentJob: null,
    completedJobs: [],
    logs: [],
    uploadedFiles: [],  // Array for multiple files
    migrationPhase: 'idle',
    migrationProgress: 0,
    migratedTables: [],
    // Bot state
    botOpen: false,
    botMessages: [],
    botTyping: false
};

var config = {
    project: {
        id: 'PROJ-2024-001',
        name: 'Mustermann GmbH',
        customer: 'DEMO',
        template: 'RETAIL_CORE_DE',
        source: 'ECC 6.0',
        target: 'S/4HANA 2023'
    },
    fi: {
        company_codes: [
            { code: '1000', name: 'Hauptsitz', currency: 'EUR', country: 'DE' },
            { code: '1100', name: 'Werk Nord', currency: 'EUR', country: 'DE' }
        ],
        gl_accounts: 85,
        tax_codes: 12,
        payment_terms: 8,
        house_banks: 3
    },
    co: {
        controlling_area: '1000',
        cost_centers: 24,
        profit_centers: 6,
        cost_elements: 45,
        internal_orders: 120
    },
    mm: {
        plants: 3,
        storage_locations: 12,
        materials: 2500,
        purchasing_orgs: 2,
        vendors: 180
    },
    sd: {
        sales_orgs: 2,
        distribution_channels: 3,
        divisions: 2,
        customers: 450,
        condition_types: 25
    }
};

// ECC to S/4 Table Mappings
var eccToS4Mappings = [
    { ecc: 'KNA1 + KNB1', s4: 'BUT000 + BP', desc: 'Customer → Business Partner', records: 450 },
    { ecc: 'LFA1 + LFB1', s4: 'BUT000 + BP', desc: 'Vendor → Business Partner', records: 180 },
    { ecc: 'BKPF + BSEG', s4: 'ACDOCA', desc: 'FI Documents → Universal Journal', records: 125000 },
    { ecc: 'COEP + COBK', s4: 'ACDOCP', desc: 'CO Documents → Universal Journal', records: 45000 },
    { ecc: 'MBEW + EBEW', s4: 'ACDOCA', desc: 'Material Ledger → Universal Journal', records: 8500 },
    { ecc: 'VBAK + VBAP', s4: 'VBAK + VBAP', desc: 'Sales Orders (kompatibel)', records: 32000 }
];

// Execution Plan
var executionPlan = {
    jobs: [
        { id: 'cust_FI_CORE', type: 'customizing', name: 'Customizing: FI Core', module: 'FI', steps: 12, duration: 2500 },
        { id: 'cust_FI_GL', type: 'customizing', name: 'Customizing: FI GL Accounts', module: 'FI', steps: 85, duration: 3000 },
        { id: 'cust_CO_CORE', type: 'customizing', name: 'Customizing: CO Core', module: 'CO', steps: 8, duration: 2000 },
        { id: 'cust_MM_ORG', type: 'customizing', name: 'Customizing: MM Org', module: 'MM', steps: 15, duration: 2500 },
        { id: 'cust_SD_ORG', type: 'customizing', name: 'Customizing: SD Org', module: 'SD', steps: 18, duration: 2500 },
        { id: 'migr_BP', type: 'migration', name: 'Migration: Business Partner', records: 630, duration: 4000 },
        { id: 'migr_MAT', type: 'migration', name: 'Migration: Materials', records: 2500, duration: 5000 },
        { id: 'migr_CUST', type: 'migration', name: 'Migration: Customer Data', records: 450, duration: 3500 },
        { id: 'migr_VEND', type: 'migration', name: 'Migration: Vendor Data', records: 180, duration: 2500 },
        { id: 'migr_GL', type: 'migration', name: 'Migration: GL Balances', records: 850, duration: 3000 },
        { id: 'test_API', type: 'testing', name: 'Testing: API Health', cases: 8, duration: 2000 },
        { id: 'test_BAPI', type: 'testing', name: 'Testing: BAPI Functions', cases: 12, duration: 2500 },
        { id: 'test_P2P', type: 'testing', name: 'Testing: P2P Process', cases: 6, duration: 3000 },
        { id: 'test_O2C', type: 'testing', name: 'Testing: O2C Process', cases: 8, duration: 3000 },
        { id: 'test_R2R', type: 'testing', name: 'Testing: R2R Process', cases: 5, duration: 2500 }
    ]
};

// Excel Templates
var excelTemplates = [
    { id: 'company_codes', name: 'Buchungskreise', icon: 'building-2', module: 'FI', rows: 6 },
    { id: 'gl_accounts', name: 'Sachkonten', icon: 'calculator', module: 'FI', rows: 85 },
    { id: 'cost_centers', name: 'Kostenstellen', icon: 'target', module: 'CO', rows: 24 },
    { id: 'profit_centers', name: 'Profit Center', icon: 'pie-chart', module: 'CO', rows: 6 },
    { id: 'plants', name: 'Werke', icon: 'factory', module: 'MM', rows: 3 },
    { id: 'materials', name: 'Materialstamm', icon: 'package', module: 'MM', rows: 2500 },
    { id: 'vendors', name: 'Lieferanten', icon: 'truck', module: 'MM', rows: 180 },
    { id: 'customers', name: 'Kunden', icon: 'users', module: 'SD', rows: 450 },
    { id: 'sales_orgs', name: 'Vertriebsorg.', icon: 'store', module: 'SD', rows: 2 },
    { id: 'conditions', name: 'Konditionen', icon: 'percent', module: 'SD', rows: 25 }
];

// ABAP Programs
var abapPrograms = [
    { id: 'Z_FACTORY_BP_CREATE', name: 'Business Partner Anlage', type: 'Report', lines: 450 },
    { id: 'Z_FACTORY_CUST_LOAD', name: 'Customizing Loader', type: 'Report', lines: 680 },
    { id: 'Z_FACTORY_MIGR_DATA', name: 'Datenmigration Framework', type: 'Report', lines: 920 },
    { id: 'Z_FACTORY_TEST_API', name: 'API Test Framework', type: 'Report', lines: 340 },
    { id: 'Z_FACTORY_RECON', name: 'Reconciliation Report', type: 'Report', lines: 560 },
    { id: 'ZCL_FACTORY_ADAPTER', name: 'SAP Adapter Class', type: 'Class', lines: 1250 }
];

// YAML Config
var exampleYaml = 'project:\n  name: "' + config.project.name + ' S/4HANA Migration"\n  customer: "' + config.project.customer + '"\n  template: "RETAIL_CORE_DE"\n\nlandscape:\n  systems:\n    - id: DEV\n      client: "100"\n    - id: QAS\n      client: "200"\n\nscope:\n  country: ["DE"]\n  modules: ["FI", "CO", "MM", "SD"]\n  org:\n    company_codes:\n      - code: "1000"\n        currency: "EUR"\n    plants:\n      - code: "1000"\n\ncustomizing:\n  packages:\n    - id: "FI_CORE"\n      target: "DEV"\n      steps:\n        - action: "set_table"\n          table: "T001"\n          key: {BUKRS: "1000"}\n          values: {BUTXT: "' + config.project.name + '"}\n\nmigration:\n  objects:\n    - id: "BUSINESS_PARTNER"\n      source: "csv"\n      mapping:\n        BP_ID: "PARTNER"\n        NAME: "NAME_ORG1"\n\ntesting:\n  suites:\n    - id: "SMOKE_API"\n      target: "DEV"\n      cases:\n        - id: "API_HEALTH"\n          type: "api"\n          expected_status: 200';

// ============================================================================
// NAVIGATION
// ============================================================================
function setTab(tab) {
    state.activeTab = tab;
    document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
    var tabEl = document.getElementById('tab-' + tab);
    if (tabEl) tabEl.classList.add('active');

    var titles = {
        dashboard: ['Dashboard', 'Übersicht und KPIs'],
        architecture: ['Architektur', 'System-Komponenten und Datenfluss'],
        config: ['YAML Konfiguration', 'Implementation Model bearbeiten'],
        templates: ['Excel Templates', 'Stammdaten-Vorlagen hochladen'],
        migration: ['ECC → S/4HANA', 'Tabellen-Transformation simulieren'],
        execution: ['Ausführung', 'Implementation Run starten'],
        artifacts: ['Artefakte', 'Generierte JSON-Dokumente'],
        downloads: ['ABAP & Transport', 'Code und Transporte herunterladen'],
        api: ['API Explorer', 'REST Endpoints testen']
    };

    document.getElementById('page-title').textContent = titles[tab][0];
    document.getElementById('page-subtitle').textContent = titles[tab][1];
    render();
}

// ============================================================================
// RENDERING
// ============================================================================
function render() {
    var content = document.getElementById('content-area');
    var html = '';

    switch (state.activeTab) {
        case 'dashboard': html = renderDashboard(); break;
        case 'architecture': html = renderArchitecture(); break;
        case 'config': html = renderConfig(); break;
        case 'templates': html = renderTemplates(); break;
        case 'migration': html = renderMigration(); break;
        case 'execution': html = renderExecution(); break;
        case 'artifacts': html = renderArtifacts(); break;
        case 'downloads': html = renderDownloads(); break;
        case 'api': html = renderAPI(); break;
    }

    content.innerHTML = html;
    lucide.createIcons();
    setupEventListeners();
}

function renderDashboard() {
    var html = '';

    // KPI Cards
    html += '<div class="grid grid-cols-4 gap-6 mb-8">';

    html += '<div class="card rounded-xl p-6 glow-blue module-card">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">';
    html += '<i data-lucide="cpu" class="w-6 h-6 text-blue-400"></i></div>';
    html += '<span class="text-3xl font-bold text-blue-400">100%</span></div>';
    html += '<div class="text-slate-300 font-medium">Automatisierung</div>';
    html += '<div class="text-slate-500 text-sm">Vollständig automatisiert</div></div>';

    html += '<div class="card rounded-xl p-6 glow-green module-card">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">';
    html += '<i data-lucide="trending-down" class="w-6 h-6 text-green-400"></i></div>';
    html += '<span class="text-3xl font-bold text-green-400">67%</span></div>';
    html += '<div class="text-slate-300 font-medium">Kostenersparnis</div>';
    html += '<div class="text-slate-500 text-sm">vs. klassisches Projekt</div></div>';

    html += '<div class="card rounded-xl p-6 glow-purple module-card">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">';
    html += '<i data-lucide="clock" class="w-6 h-6 text-purple-400"></i></div>';
    html += '<span class="text-3xl font-bold text-purple-400">85h</span></div>';
    html += '<div class="text-slate-300 font-medium">Zeit gespart</div>';
    html += '<div class="text-slate-500 text-sm">Pro Implementierungsphase</div></div>';

    html += '<div class="card rounded-xl p-6 glow-amber module-card">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center">';
    html += '<i data-lucide="check-circle" class="w-6 h-6 text-amber-400"></i></div>';
    html += '<span class="text-3xl font-bold text-amber-400">99.2%</span></div>';
    html += '<div class="text-slate-300 font-medium">Erfolgsrate</div>';
    html += '<div class="text-slate-500 text-sm">First-time-right</div></div>';

    html += '</div>';

    // Module Overview
    html += '<div class="grid grid-cols-4 gap-4 mb-8">';

    var modules = [
        { id: 'FI', name: 'Financial Accounting', icon: 'landmark', color: 'blue', items: [config.fi.company_codes.length + ' Buchungskreise', config.fi.gl_accounts + ' Sachkonten', config.fi.tax_codes + ' Steuerkennz.'] },
        { id: 'CO', name: 'Controlling', icon: 'pie-chart', color: 'purple', items: [config.co.cost_centers + ' Kostenstellen', config.co.profit_centers + ' Profit Center', config.co.cost_elements + ' Kostenarten'] },
        { id: 'MM', name: 'Materials Mgmt', icon: 'package', color: 'cyan', items: [config.mm.plants + ' Werke', config.mm.materials + ' Materialien', config.mm.vendors + ' Lieferanten'] },
        { id: 'SD', name: 'Sales & Distrib.', icon: 'shopping-cart', color: 'green', items: [config.sd.sales_orgs + ' Vertriebsorg.', config.sd.customers + ' Kunden', config.sd.condition_types + ' Konditionen'] }
    ];

    for (var i = 0; i < modules.length; i++) {
        var m = modules[i];
        html += '<div class="card rounded-xl p-5 module-card">';
        html += '<div class="flex items-center gap-3 mb-4">';
        html += '<div class="w-10 h-10 rounded-lg bg-' + m.color + '-500/20 flex items-center justify-center">';
        html += '<i data-lucide="' + m.icon + '" class="w-5 h-5 text-' + m.color + '-400"></i></div>';
        html += '<div><div class="font-bold text-' + m.color + '-400">' + m.id + '</div>';
        html += '<div class="text-xs text-slate-400">' + m.name + '</div></div></div>';
        html += '<div class="space-y-1 text-sm text-slate-300">';
        for (var j = 0; j < m.items.length; j++) {
            html += '<div class="flex items-center gap-2"><i data-lucide="check" class="w-3 h-3 text-' + m.color + '-400"></i>' + m.items[j] + '</div>';
        }
        html += '</div></div>';
    }
    html += '</div>';

    // Uploaded Files Section (shown when files are uploaded)
    if (state.uploadedFiles.length > 0) {
        var totalRecords = state.uploadedFiles.reduce(function(sum, f) { return sum + f.rows; }, 0);
        html += '<div class="card rounded-xl p-6 mb-8 border border-green-500/30 bg-green-500/5">';
        html += '<div class="flex items-center justify-between mb-4">';
        html += '<h3 class="text-lg font-semibold flex items-center gap-2">';
        html += '<i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-400"></i> Hochgeladene Dateien';
        html += '<span class="text-sm font-normal text-green-400 bg-green-500/20 px-2 py-0.5 rounded-full">' + state.uploadedFiles.length + ' Dateien • ' + totalRecords.toLocaleString() + ' Datensätze</span></h3>';
        html += '<button onclick="clearUploadedFiles()" class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">';
        html += '<i data-lucide="trash-2" class="w-3 h-3"></i> Alle entfernen</button></div>';
        html += '<div class="grid grid-cols-3 gap-3">';
        for (var u = 0; u < state.uploadedFiles.length; u++) {
            var uf = state.uploadedFiles[u];
            var ufColor = uf.type === 'company_codes' ? 'blue' : uf.type === 'gl_accounts' ? 'blue' :
                          uf.type === 'cost_centers' ? 'purple' : uf.type === 'profit_centers' ? 'purple' :
                          uf.type === 'materials' ? 'cyan' : uf.type === 'vendors' ? 'cyan' :
                          uf.type === 'customers' ? 'green' : uf.type === 'sales_orgs' ? 'green' : 'slate';
            html += '<div class="flex items-center gap-3 p-3 rounded-lg bg-slate-800/70 border border-slate-700">';
            html += '<div class="w-10 h-10 rounded-lg bg-' + ufColor + '-500/20 flex items-center justify-center">';
            html += '<i data-lucide="file-spreadsheet" class="w-5 h-5 text-' + ufColor + '-400"></i></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="text-sm font-medium truncate">' + uf.name + '</div>';
            html += '<div class="text-xs text-slate-400">' + uf.rows.toLocaleString() + ' Zeilen • ' + (uf.detectedType || uf.type) + '</div></div>';
            html += '<button onclick="removeUploadedFile(' + u + ')" class="p-1 text-slate-500 hover:text-red-400">';
            html += '<i data-lucide="x" class="w-4 h-4"></i></button></div>';
        }
        html += '</div></div>';
    }

    // Two Column Layout
    html += '<div class="grid grid-cols-2 gap-6">';

    // Pipeline
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="text-lg font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="git-merge" class="w-5 h-5 text-blue-400"></i> Execution Pipeline</h3>';
    html += '<div class="space-y-3">';

    var phases = [
        { name: 'Parser', desc: 'YAML → Domain Model', icon: 'file-search', color: 'blue' },
        { name: 'Planner', desc: 'Model → Execution Plan', icon: 'list-tree', color: 'purple' },
        { name: 'Customizing', desc: 'FI/CO/MM/SD Config', icon: 'settings', color: 'amber' },
        { name: 'Migration', desc: 'BP, Material, Balances', icon: 'database', color: 'cyan' },
        { name: 'Testing', desc: 'API + Process Tests', icon: 'test-tube', color: 'green' }
    ];

    for (var k = 0; k < phases.length; k++) {
        var p = phases[k];
        html += '<div class="flex items-center gap-3">';
        html += '<div class="w-9 h-9 rounded-lg bg-' + p.color + '-500/20 flex items-center justify-center">';
        html += '<i data-lucide="' + p.icon + '" class="w-4 h-4 text-' + p.color + '-400"></i></div>';
        html += '<div class="flex-1"><div class="font-medium text-sm">' + p.name + '</div>';
        html += '<div class="text-xs text-slate-400">' + p.desc + '</div></div>';
        if (k < phases.length - 1) html += '<i data-lucide="chevron-right" class="w-4 h-4 text-slate-600"></i>';
        html += '</div>';
    }
    html += '</div></div>';

    // Company Codes
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="text-lg font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="building-2" class="w-5 h-5 text-amber-400"></i> Buchungskreise</h3>';
    html += '<div class="space-y-2">';

    for (var l = 0; l < config.fi.company_codes.length; l++) {
        var cc = config.fi.company_codes[l];
        html += '<div class="flex items-center justify-between p-3 rounded-lg bg-slate-800/50">';
        html += '<div class="flex items-center gap-3">';
        html += '<span class="w-14 text-center font-mono text-sm bg-amber-500/20 text-amber-300 rounded px-2 py-1">' + cc.code + '</span>';
        html += '<span class="text-sm">' + cc.name + '</span></div>';
        html += '<div class="flex items-center gap-2">';
        html += '<span class="text-xs text-slate-400">' + cc.currency + '</span>';
        html += '<span class="text-xs bg-slate-700 rounded px-2 py-0.5">' + cc.country + '</span>';
        html += '</div></div>';
    }
    html += '</div></div>';

    html += '</div>';

    return html;
}

function renderArchitecture() {
    var html = '';

    html += '<div class="card rounded-xl p-8 mb-6">';
    html += '<h3 class="text-lg font-semibold mb-6">System Architektur</h3>';

    // API Layer
    html += '<div class="flex justify-center mb-6">';
    html += '<div class="card-highlight rounded-xl p-4 w-[450px] text-center">';
    html += '<div class="flex items-center justify-center gap-2 mb-2">';
    html += '<i data-lucide="globe" class="w-5 h-5 text-blue-400"></i>';
    html += '<span class="font-semibold">FastAPI REST API</span></div>';
    html += '<div class="text-sm text-slate-400">POST /runs • GET /runs/{id} • GET /artifacts</div></div></div>';

    html += '<div class="flex justify-center mb-6"><i data-lucide="arrow-down" class="w-6 h-6 text-slate-600"></i></div>';

    // Engine
    html += '<div class="grid grid-cols-3 gap-4 mb-6 max-w-3xl mx-auto">';
    var engine = [
        { name: 'Parser', desc: 'YAML → Model', icon: 'file-search', file: 'parser.py' },
        { name: 'Planner', desc: 'Model → Plan', icon: 'list-tree', file: 'planner.py' },
        { name: 'Executor', desc: 'Plan → Jobs', icon: 'play', file: 'executor.py' }
    ];
    for (var i = 0; i < engine.length; i++) {
        var e = engine[i];
        html += '<div class="card rounded-xl p-4 text-center">';
        html += '<div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center mx-auto mb-2">';
        html += '<i data-lucide="' + e.icon + '" class="w-5 h-5 text-purple-400"></i></div>';
        html += '<div class="font-medium">' + e.name + '</div>';
        html += '<div class="text-xs text-slate-400">' + e.desc + '</div>';
        html += '<div class="text-xs font-mono text-slate-500 mt-1">' + e.file + '</div></div>';
    }
    html += '</div>';

    html += '<div class="flex justify-center mb-6"><i data-lucide="arrow-down" class="w-6 h-6 text-slate-600"></i></div>';

    // Plugins
    html += '<div class="grid grid-cols-3 gap-4 mb-6 max-w-3xl mx-auto">';
    var plugins = [
        { name: 'CustomizingPlugin', desc: 'SAP Config', icon: 'settings', color: 'amber' },
        { name: 'MigrationPlugin', desc: 'Data Load', icon: 'database', color: 'cyan' },
        { name: 'TestingPlugin', desc: 'Auto Tests', icon: 'test-tube', color: 'green' }
    ];
    for (var j = 0; j < plugins.length; j++) {
        var pl = plugins[j];
        html += '<div class="card rounded-xl p-4 text-center border-' + pl.color + '-500/30">';
        html += '<div class="w-10 h-10 rounded-lg bg-' + pl.color + '-500/20 flex items-center justify-center mx-auto mb-2">';
        html += '<i data-lucide="' + pl.icon + '" class="w-5 h-5 text-' + pl.color + '-400"></i></div>';
        html += '<div class="font-medium">' + pl.name + '</div>';
        html += '<div class="text-xs text-slate-400">' + pl.desc + '</div></div>';
    }
    html += '</div>';

    html += '<div class="flex justify-center mb-6"><i data-lucide="arrow-down" class="w-6 h-6 text-slate-600"></i></div>';

    // Systems
    html += '<div class="flex justify-center gap-8">';
    html += '<div class="card rounded-xl p-4 text-center w-52 border-amber-500/30">';
    html += '<div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center mx-auto mb-2">';
    html += '<i data-lucide="database" class="w-5 h-5 text-amber-400"></i></div>';
    html += '<div class="font-medium">Source System</div>';
    html += '<div class="text-xs text-amber-400">ECC 6.0</div></div>';

    html += '<div class="flex items-center">';
    html += '<i data-lucide="arrow-right" class="w-8 h-8 text-blue-400"></i></div>';

    html += '<div class="card rounded-xl p-4 text-center w-52 border-green-500/30">';
    html += '<div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center mx-auto mb-2">';
    html += '<i data-lucide="server" class="w-5 h-5 text-green-400"></i></div>';
    html += '<div class="font-medium">Target System</div>';
    html += '<div class="text-xs text-green-400">S/4HANA 2023</div></div>';
    html += '</div>';

    html += '</div>';

    return html;
}

function renderConfig() {
    var html = '';

    html += '<div class="grid grid-cols-2 gap-6">';

    // YAML Editor
    html += '<div class="card rounded-xl p-6">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<h3 class="font-semibold flex items-center gap-2">';
    html += '<i data-lucide="file-code" class="w-5 h-5 text-blue-400"></i> Implementation Model</h3>';
    html += '<button onclick="validateConfig()" class="px-3 py-1.5 text-sm bg-blue-600 rounded-lg hover:bg-blue-500 flex items-center gap-2">';
    html += '<i data-lucide="check" class="w-4 h-4"></i> Validieren</button></div>';
    html += '<textarea id="yaml-editor" class="yaml-editor w-full h-[500px] p-4 rounded-lg text-slate-300 resize-none">' + exampleYaml + '</textarea>';
    html += '</div>';

    // Parsed View
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="eye" class="w-5 h-5 text-green-400"></i> Parsed Configuration</h3>';
    html += '<div class="space-y-3 max-h-[500px] overflow-auto">';

    html += '<div class="p-3 rounded-lg bg-slate-800/50">';
    html += '<div class="flex items-center gap-2 mb-2"><i data-lucide="folder" class="w-4 h-4 text-blue-400"></i><span class="font-medium">Project</span></div>';
    html += '<div class="text-sm text-slate-400 ml-6">Name: <span class="text-white">' + config.project.name + '</span></div>';
    html += '<div class="text-sm text-slate-400 ml-6">Customer: <span class="text-white">' + config.project.customer + '</span></div></div>';

    html += '<div class="p-3 rounded-lg bg-slate-800/50">';
    html += '<div class="flex items-center gap-2 mb-2"><i data-lucide="server" class="w-4 h-4 text-purple-400"></i><span class="font-medium">Landscape</span></div>';
    html += '<div class="flex gap-2 ml-6">';
    html += '<span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">DEV (100)</span>';
    html += '<span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">QAS (200)</span></div></div>';

    html += '<div class="p-3 rounded-lg bg-slate-800/50">';
    html += '<div class="flex items-center gap-2 mb-2"><i data-lucide="layers" class="w-4 h-4 text-amber-400"></i><span class="font-medium">Scope</span></div>';
    html += '<div class="flex gap-2 ml-6 flex-wrap">';
    html += '<span class="px-2 py-1 bg-blue-500/20 text-blue-300 rounded text-xs">FI</span>';
    html += '<span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs">CO</span>';
    html += '<span class="px-2 py-1 bg-cyan-500/20 text-cyan-300 rounded text-xs">MM</span>';
    html += '<span class="px-2 py-1 bg-green-500/20 text-green-300 rounded text-xs">SD</span></div></div>';

    html += '<div class="p-3 rounded-lg bg-slate-800/50">';
    html += '<div class="flex items-center gap-2 mb-2"><i data-lucide="settings" class="w-4 h-4 text-cyan-400"></i><span class="font-medium">Customizing</span>';
    html += '<span class="text-xs bg-cyan-500/20 text-cyan-300 px-2 py-0.5 rounded">5 Packages</span></div>';
    html += '<div class="ml-6 text-sm text-slate-400">FI_CORE, FI_GL, CO_CORE, MM_ORG, SD_ORG</div></div>';

    html += '<div class="p-3 rounded-lg bg-slate-800/50">';
    html += '<div class="flex items-center gap-2 mb-2"><i data-lucide="database" class="w-4 h-4 text-green-400"></i><span class="font-medium">Migration</span>';
    html += '<span class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded">5 Objects</span></div>';
    html += '<div class="ml-6 text-sm text-slate-400">BP, Materials, Customers, Vendors, GL</div></div>';

    html += '<div class="p-3 rounded-lg bg-slate-800/50">';
    html += '<div class="flex items-center gap-2 mb-2"><i data-lucide="test-tube" class="w-4 h-4 text-emerald-400"></i><span class="font-medium">Testing</span>';
    html += '<span class="text-xs bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded">5 Suites</span></div>';
    html += '<div class="ml-6 text-sm text-slate-400">API, BAPI, P2P, O2C, R2R</div></div>';

    html += '</div>';
    html += '<div id="validation-result" class="mt-4"></div>';
    html += '</div>';

    html += '</div>';

    return html;
}

function renderTemplates() {
    var html = '';

    // Upload Zone
    html += '<div class="card rounded-xl p-6 mb-6">';
    html += '<div class="upload-zone rounded-xl p-8 text-center" id="upload-zone">';
    html += '<i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mx-auto mb-4"></i>';
    html += '<div class="text-lg font-medium mb-2">Excel-Templates hochladen</div>';
    html += '<div class="text-sm text-slate-400 mb-4">Mehrere Dateien per Drag & Drop oder Klick auswählen</div>';
    html += '<input type="file" id="file-input" accept=".xlsx,.xls,.csv" multiple class="hidden">';
    html += '<button onclick="document.getElementById(\'file-input\').click()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500">Dateien auswählen</button>';

    // Show uploaded files list
    if (state.uploadedFiles.length > 0) {
        html += '<div class="mt-6 text-left">';
        html += '<div class="flex items-center justify-between mb-3">';
        html += '<span class="text-sm font-medium text-slate-300">' + state.uploadedFiles.length + ' Datei(en) hochgeladen</span>';
        html += '<button onclick="clearUploadedFiles()" class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">';
        html += '<i data-lucide="trash-2" class="w-3 h-3"></i> Alle entfernen</button></div>';
        html += '<div class="space-y-2 max-h-48 overflow-auto">';

        for (var i = 0; i < state.uploadedFiles.length; i++) {
            var f = state.uploadedFiles[i];
            var typeColor = f.type === 'company_codes' ? 'blue' : f.type === 'gl_accounts' ? 'blue' :
                           f.type === 'cost_centers' ? 'purple' : f.type === 'materials' ? 'cyan' :
                           f.type === 'customers' ? 'green' : f.type === 'vendors' ? 'cyan' : 'slate';

            html += '<div class="flex items-center gap-3 p-3 rounded-lg bg-slate-800/50 border border-slate-700">';
            html += '<div class="w-8 h-8 rounded bg-green-500/20 flex items-center justify-center">';
            html += '<i data-lucide="file-spreadsheet" class="w-4 h-4 text-green-400"></i></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="text-sm font-medium truncate">' + f.name + '</div>';
            html += '<div class="text-xs text-slate-500">' + f.rows + ' Zeilen' + (f.detectedType ? ' • ' + f.detectedType : '') + '</div></div>';
            if (f.type) {
                html += '<span class="text-xs bg-' + typeColor + '-500/20 text-' + typeColor + '-300 px-2 py-0.5 rounded">' + f.type + '</span>';
            }
            html += '<button onclick="removeUploadedFile(' + i + ')" class="p-1 text-slate-500 hover:text-red-400">';
            html += '<i data-lucide="x" class="w-4 h-4"></i></button>';
            html += '</div>';
        }
        html += '</div></div>';
    }
    html += '</div></div>';

    // Template Grid
    html += '<h3 class="text-lg font-semibold mb-4">Verfügbare Templates</h3>';
    html += '<div class="grid grid-cols-5 gap-4">';

    for (var i = 0; i < excelTemplates.length; i++) {
        var t = excelTemplates[i];
        var modColor = t.module === 'FI' ? 'blue' : t.module === 'CO' ? 'purple' : t.module === 'MM' ? 'cyan' : 'green';
        html += '<div class="card rounded-xl p-4 module-card cursor-pointer" onclick="downloadTemplate(\'' + t.id + '\')">';
        html += '<div class="w-10 h-10 rounded-lg bg-' + modColor + '-500/20 flex items-center justify-center mb-3">';
        html += '<i data-lucide="' + t.icon + '" class="w-5 h-5 text-' + modColor + '-400"></i></div>';
        html += '<div class="font-medium text-sm">' + t.name + '</div>';
        html += '<div class="flex items-center justify-between mt-2">';
        html += '<span class="text-xs bg-' + modColor + '-500/20 text-' + modColor + '-300 px-2 py-0.5 rounded">' + t.module + '</span>';
        html += '<span class="text-xs text-slate-400">' + t.rows + ' rows</span></div>';
        html += '</div>';
    }

    html += '</div>';

    return html;
}

function renderMigration() {
    var html = '';

    // Header
    html += '<div class="card rounded-xl p-6 mb-6">';
    html += '<div class="flex items-center justify-between">';
    html += '<div>';
    html += '<h3 class="text-lg font-semibold">ECC 6.0 → S/4HANA 2023 Migration</h3>';
    html += '<p class="text-sm text-slate-400">CVI Business Partner Migration & Universal Journal</p></div>';
    html += '<button onclick="startMigration()" class="px-6 py-2 bg-gradient-to-r from-amber-600 to-orange-600 rounded-lg font-medium hover:opacity-90 flex items-center gap-2">';
    html += '<i data-lucide="arrow-right-left" class="w-4 h-4"></i> Migration starten</button></div>';

    if (state.migrationPhase !== 'idle') {
        html += '<div class="mt-6">';
        html += '<div class="flex items-center justify-between mb-2">';
        html += '<span class="text-sm text-slate-400">Fortschritt</span>';
        html += '<span class="text-sm font-medium">' + state.migrationProgress + '%</span></div>';
        html += '<div class="h-3 bg-slate-700 rounded-full overflow-hidden">';
        html += '<div class="h-full progress-bar rounded-full transition-all" style="width:' + state.migrationProgress + '%"></div></div></div>';
    }
    html += '</div>';

    // Table Mappings
    html += '<div class="grid grid-cols-1 gap-4">';

    for (var i = 0; i < eccToS4Mappings.length; i++) {
        var m = eccToS4Mappings[i];
        var isMigrated = state.migratedTables.indexOf(i) !== -1;
        var borderClass = isMigrated ? 'border-green-500/30' : '';
        var bgClass = isMigrated ? 'bg-green-500/5' : '';

        html += '<div class="card rounded-xl p-5 ' + borderClass + ' ' + bgClass + '">';
        html += '<div class="flex items-center gap-6">';

        // ECC Side
        html += '<div class="flex-1">';
        html += '<div class="text-xs text-slate-400 mb-1">ECC 6.0</div>';
        html += '<div class="font-mono text-lg text-amber-400">' + m.ecc + '</div></div>';

        // Arrow
        html += '<div class="flex items-center gap-2">';
        if (isMigrated) {
            html += '<i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>';
        } else {
            html += '<i data-lucide="arrow-right" class="w-6 h-6 text-slate-400 data-flow"></i>';
        }
        html += '</div>';

        // S/4 Side
        html += '<div class="flex-1">';
        html += '<div class="text-xs text-slate-400 mb-1">S/4HANA</div>';
        html += '<div class="font-mono text-lg text-green-400">' + m.s4 + '</div></div>';

        // Details
        html += '<div class="text-right">';
        html += '<div class="text-sm text-slate-300">' + m.desc + '</div>';
        html += '<div class="text-xs text-slate-500">' + m.records.toLocaleString() + ' Datensätze</div></div>';

        html += '</div></div>';
    }

    html += '</div>';

    return html;
}

function renderExecution() {
    var html = '';

    // Control Panel
    html += '<div class="card rounded-xl p-6 mb-6">';
    html += '<div class="flex items-center justify-between">';
    html += '<div>';
    html += '<h3 class="text-lg font-semibold">Execution Control</h3>';
    html += '<p class="text-sm text-slate-400">' + executionPlan.jobs.length + ' Jobs • FI/CO/MM/SD Customizing + Migration + Testing</p></div>';
    html += '<div class="flex gap-3">';

    if (state.runStatus === 'idle') {
        html += '<button onclick="startRun()" class="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-medium hover:opacity-90 flex items-center gap-2">';
        html += '<i data-lucide="play" class="w-4 h-4"></i> Run starten</button>';
    } else if (state.runStatus === 'executing') {
        html += '<button onclick="stopRun()" class="px-6 py-2 bg-red-600 rounded-lg font-medium hover:opacity-90 flex items-center gap-2">';
        html += '<i data-lucide="square" class="w-4 h-4"></i> Stoppen</button>';
    } else {
        html += '<button onclick="resetRun()" class="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500 flex items-center gap-2">';
        html += '<i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset</button>';
        html += '<button onclick="startRun()" class="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-medium hover:opacity-90 flex items-center gap-2">';
        html += '<i data-lucide="play" class="w-4 h-4"></i> Neuer Run</button>';
    }

    html += '</div></div>';

    if (state.runStatus !== 'idle') {
        html += '<div class="mt-6">';
        html += '<div class="flex items-center justify-between mb-2">';
        html += '<span class="text-sm text-slate-400">Fortschritt</span>';
        html += '<span class="text-sm font-medium">' + state.runProgress + '%</span></div>';
        html += '<div class="h-3 bg-slate-700 rounded-full overflow-hidden">';
        html += '<div class="h-full progress-bar rounded-full transition-all" style="width:' + state.runProgress + '%"></div></div>';
        if (state.currentJob) {
            html += '<div class="mt-2 text-sm text-slate-400">Aktuell: <span class="text-white">' + state.currentJob + '</span></div>';
        }
        html += '</div>';
    }
    html += '</div>';

    // Two Columns
    html += '<div class="grid grid-cols-2 gap-6">';

    // Job List
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="list-checks" class="w-5 h-5 text-blue-400"></i> Execution Plan</h3>';
    html += '<div class="space-y-2 max-h-96 overflow-auto">';

    for (var i = 0; i < executionPlan.jobs.length; i++) {
        var job = executionPlan.jobs[i];
        var isCompleted = state.completedJobs.indexOf(job.id) !== -1;
        var isCurrent = state.currentJob === job.name;

        var bgColor = 'bg-slate-800/50';
        var iconColor = 'text-slate-500';
        var icon = 'circle';
        var typeColor = job.type === 'customizing' ? 'amber' : job.type === 'migration' ? 'cyan' : 'green';

        if (isCompleted) { bgColor = 'bg-green-500/10'; iconColor = 'text-green-500'; icon = 'check-circle'; }
        else if (isCurrent) { bgColor = 'bg-blue-500/10'; iconColor = 'text-blue-500'; icon = 'loader'; }

        html += '<div class="flex items-center gap-3 p-3 rounded-lg ' + bgColor + '">';
        html += '<i data-lucide="' + icon + '" class="w-5 h-5 ' + iconColor + (isCurrent ? ' spin' : '') + '"></i>';
        html += '<div class="flex-1">';
        html += '<div class="text-sm font-medium">' + job.name + '</div>';
        html += '<div class="text-xs text-slate-500">' + (job.steps ? job.steps + ' steps' : job.records ? job.records + ' records' : job.cases + ' cases') + '</div></div>';
        html += '<span class="text-xs bg-' + typeColor + '-500/20 text-' + typeColor + '-300 px-2 py-0.5 rounded">' + job.type + '</span>';
        html += '</div>';
    }

    html += '</div></div>';

    // Logs
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="scroll-text" class="w-5 h-5 text-purple-400"></i> Execution Log</h3>';
    html += '<div id="log-container" class="space-y-1 max-h-96 overflow-auto font-mono text-xs">';

    if (state.logs.length === 0) {
        html += '<div class="text-slate-500 text-center py-8">Keine Logs vorhanden</div>';
    } else {
        for (var j = 0; j < state.logs.length; j++) {
            var log = state.logs[j];
            var logClass = log.level === 'SUCCESS' ? 'log-success' : log.level === 'ERROR' ? 'log-error' : log.level === 'WARNING' ? 'log-warning' : 'log-info';
            var textClass = log.level === 'SUCCESS' ? 'text-green-400' : log.level === 'ERROR' ? 'text-red-400' : 'text-slate-300';
            html += '<div class="log-entry ' + logClass + ' p-2 rounded">';
            html += '<span class="text-slate-500">' + log.time + '</span> ';
            html += '<span class="' + textClass + '">' + log.message + '</span></div>';
        }
    }

    html += '</div></div>';
    html += '</div>';

    return html;
}

function renderArtifacts() {
    var html = '';

    if (state.runStatus === 'idle') {
        html += '<div class="card rounded-xl p-12 text-center">';
        html += '<i data-lucide="archive" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>';
        html += '<h3 class="text-xl font-semibold mb-2">Keine Artefakte vorhanden</h3>';
        html += '<p class="text-slate-400 mb-6">Starten Sie einen Run, um Artefakte zu generieren.</p>';
        html += '<button onclick="setTab(\'execution\')" class="px-6 py-2 bg-blue-600 rounded-lg">Zur Ausführung</button></div>';
        return html;
    }

    html += '<div class="grid grid-cols-3 gap-6">';

    // Tree
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="folder-tree" class="w-5 h-5 text-amber-400"></i> Artefakt-Struktur</h3>';
    html += '<div class="artifact-tree space-y-1">';
    html += '<div class="text-blue-400">📁 artifacts/' + (state.currentRun || 'run_xxx') + '/</div>';
    html += '<div class="ml-4 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'plan\')">📄 plan.json</div>';
    html += '<div class="ml-4 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'summary\')">📄 summary.json</div>';
    html += '<div class="ml-4 text-amber-400">📁 customizing/</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'cust_fi\')">📄 FI_CORE.json</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'cust_co\')">📄 CO_CORE.json</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'cust_mm\')">📄 MM_ORG.json</div>';
    html += '<div class="ml-4 text-cyan-400">📁 migration/</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'migr_bp\')">📄 BUSINESS_PARTNER.json</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'migr_mat\')">📄 MATERIAL.json</div>';
    html += '<div class="ml-4 text-green-400">📁 testing/</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'test_api\')">📄 SMOKE_API.json</div>';
    html += '<div class="ml-8 text-slate-300 cursor-pointer hover:text-white" onclick="showArtifact(\'test_p2p\')">📄 SMOKE_P2P.json</div>';
    html += '</div></div>';

    // JSON Viewer
    html += '<div class="col-span-2 card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="file-json" class="w-5 h-5 text-green-400"></i> Artefakt-Inhalt</h3>';
    html += '<div id="artifact-content" class="bg-slate-900 rounded-lg p-4 max-h-[500px] overflow-auto">';
    html += '<pre class="text-sm">' + formatJSON(getSampleArtifact('summary')) + '</pre></div></div>';

    html += '</div>';

    return html;
}

function renderDownloads() {
    var html = '';

    // ABAP Code
    html += '<div class="card rounded-xl p-6 mb-6">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<h3 class="text-lg font-semibold flex items-center gap-2">';
    html += '<i data-lucide="code" class="w-5 h-5 text-blue-400"></i> ABAP Code</h3>';
    html += '<button onclick="downloadAllABAP()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 flex items-center gap-2">';
    html += '<i data-lucide="download" class="w-4 h-4"></i> Alle herunterladen</button></div>';

    html += '<div class="grid grid-cols-3 gap-4">';
    for (var i = 0; i < abapPrograms.length; i++) {
        var p = abapPrograms[i];
        html += '<div class="card rounded-lg p-4 cursor-pointer hover:bg-slate-700/50" onclick="downloadABAP(\'' + p.id + '\')">';
        html += '<div class="font-mono text-sm text-blue-400 mb-1">' + p.id + '</div>';
        html += '<div class="text-sm text-slate-300">' + p.name + '</div>';
        html += '<div class="flex items-center justify-between mt-2">';
        html += '<span class="text-xs bg-slate-700 rounded px-2 py-0.5">' + p.type + '</span>';
        html += '<span class="text-xs text-slate-500">' + p.lines + ' lines</span></div></div>';
    }
    html += '</div></div>';

    // Transport Request
    html += '<div class="card rounded-xl p-6 mb-6">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<h3 class="text-lg font-semibold flex items-center gap-2">';
    html += '<i data-lucide="truck" class="w-5 h-5 text-amber-400"></i> Transport Request</h3>';
    html += '<button onclick="downloadTransport()" class="px-4 py-2 bg-amber-600 rounded-lg hover:bg-amber-500 flex items-center gap-2">';
    html += '<i data-lucide="download" class="w-4 h-4"></i> Transport generieren</button></div>';

    html += '<div class="grid grid-cols-2 gap-4">';
    html += '<div class="p-4 rounded-lg bg-slate-800/50">';
    html += '<div class="text-sm text-slate-400 mb-1">Transport Request</div>';
    html += '<div class="font-mono text-lg text-amber-400">DEVK900001</div>';
    html += '<div class="text-xs text-slate-500 mt-1">Customizing + Workbench</div></div>';

    html += '<div class="p-4 rounded-lg bg-slate-800/50">';
    html += '<div class="text-sm text-slate-400 mb-1">Enthaltene Objekte</div>';
    html += '<div class="text-lg font-semibold">156</div>';
    html += '<div class="text-xs text-slate-500 mt-1">Tables, Reports, Classes</div></div>';
    html += '</div></div>';

    // Documentation
    html += '<div class="card rounded-xl p-6">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<h3 class="text-lg font-semibold flex items-center gap-2">';
    html += '<i data-lucide="file-text" class="w-5 h-5 text-green-400"></i> Dokumentation</h3>';
    html += '<button onclick="downloadAllDocs()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-500 flex items-center gap-2">';
    html += '<i data-lucide="download" class="w-4 h-4"></i> Alle herunterladen</button></div>';

    var docs = [
        { id: 'impl_guide', name: 'Implementation Guide', icon: 'book-open', size: '2.4 MB' },
        { id: 'config_doc', name: 'Configuration Documentation', icon: 'settings', size: '1.8 MB' },
        { id: 'test_report', name: 'Test Execution Report', icon: 'clipboard-check', size: '890 KB' },
        { id: 'migration_log', name: 'Migration Protocol', icon: 'database', size: '1.2 MB' },
        { id: 'recon_report', name: 'Reconciliation Report', icon: 'git-compare', size: '650 KB' }
    ];

    html += '<div class="grid grid-cols-5 gap-4">';
    for (var j = 0; j < docs.length; j++) {
        var d = docs[j];
        html += '<div class="card rounded-lg p-4 cursor-pointer hover:bg-slate-700/50 text-center" onclick="downloadDoc(\'' + d.id + '\')">';
        html += '<i data-lucide="' + d.icon + '" class="w-8 h-8 text-green-400 mx-auto mb-2"></i>';
        html += '<div class="text-sm font-medium">' + d.name + '</div>';
        html += '<div class="text-xs text-slate-500 mt-1">' + d.size + '</div></div>';
    }
    html += '</div></div>';

    return html;
}

function renderAPI() {
    var html = '';

    html += '<div class="grid grid-cols-2 gap-6">';

    // Endpoints
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="route" class="w-5 h-5 text-blue-400"></i> API Endpoints</h3>';
    html += '<div class="space-y-2">';

    var endpoints = [
        { method: 'POST', path: '/runs', desc: 'Neuen Run erstellen' },
        { method: 'GET', path: '/runs/{run_id}', desc: 'Run-Status abrufen' },
        { method: 'GET', path: '/runs/{run_id}/artifacts', desc: 'Artefakte auflisten' },
        { method: 'GET', path: '/runs', desc: 'Alle Runs auflisten' },
        { method: 'DELETE', path: '/runs/{run_id}', desc: 'Run löschen' }
    ];

    for (var i = 0; i < endpoints.length; i++) {
        var ep = endpoints[i];
        var methodColor = ep.method === 'POST' ? 'green' : ep.method === 'DELETE' ? 'red' : 'blue';
        html += '<div class="flex items-center gap-3 p-3 rounded-lg bg-slate-800/50 cursor-pointer hover:bg-slate-800" onclick="setEndpoint(\'' + ep.method + '\',\'' + ep.path + '\')">';
        html += '<span class="px-2 py-0.5 text-xs font-bold rounded bg-' + methodColor + '-500">' + ep.method + '</span>';
        html += '<span class="font-mono text-sm flex-1">' + ep.path + '</span>';
        html += '<span class="text-xs text-slate-400">' + ep.desc + '</span></div>';
    }
    html += '</div></div>';

    // Tester
    html += '<div class="card rounded-xl p-6">';
    html += '<h3 class="font-semibold mb-4 flex items-center gap-2">';
    html += '<i data-lucide="terminal" class="w-5 h-5 text-green-400"></i> API Tester</h3>';
    html += '<div class="flex gap-2 mb-4">';
    html += '<select id="api-method" class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm">';
    html += '<option>GET</option><option>POST</option><option>DELETE</option></select>';
    html += '<input id="api-path" type="text" value="/runs" class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm font-mono">';
    html += '<button onclick="testAPI()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">Send</button></div>';
    html += '<div id="api-response" class="bg-slate-900 rounded-lg p-4 h-48 overflow-auto font-mono text-sm">';
    html += '<span class="text-slate-500">// Response wird hier angezeigt</span></div></div>';

    html += '</div>';

    return html;
}

// ============================================================================
// HELPERS
// ============================================================================

function formatJSON(obj) {
    var json = JSON.stringify(obj, null, 2);
    json = json.replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:');
    json = json.replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>');
    json = json.replace(/: (\d+\.?\d*)/g, ': <span class="json-number">$1</span>');
    json = json.replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');
    return json;
}

function getSampleArtifact(type) {
    var arts = {
        summary: { run_id: state.currentRun || 'run_demo', project_name: config.project.name, status: state.runStatus === 'completed' ? 'completed' : 'executing', total_jobs: 15, completed_jobs: state.completedJobs.length, success_rate: 100.0, automation_rate: 100.0, cost_savings_percent: 67.3 },
        plan: { run_id: state.currentRun, total_jobs: 15, jobs: executionPlan.jobs.slice(0, 5).map(function(j) { return { id: j.id, name: j.name, type: j.type }; }) },
        cust_fi: { package_id: 'FI_CORE', status: 'completed', steps: 12, success: 12, tables: ['T001', 'T003', 'T007A', 'T052'] },
        migr_bp: { object: 'BUSINESS_PARTNER', records_total: 630, records_loaded: 630, reconciliation: { status: 'RECONCILED', match_rate: 100.0 } },
        test_api: { suite: 'SMOKE_API', total: 8, passed: 8, failed: 0, results: [{ id: 'API_HEALTH', passed: true }, { id: 'API_BP', passed: true }] }
    };
    return arts[type] || arts.summary;
}

function showArtifact(type) {
    var el = document.getElementById('artifact-content');
    if (el) el.innerHTML = '<pre class="text-sm">' + formatJSON(getSampleArtifact(type)) + '</pre>';
}

function addLog(level, message) {
    var now = new Date();
    state.logs.push({ time: now.toTimeString().slice(0, 8), level: level, message: message });
    setTimeout(function() {
        var c = document.getElementById('log-container');
        if (c) c.scrollTop = c.scrollHeight;
    }, 50);
}

// ============================================================================
// ACTIONS
// ============================================================================

function startNewRun() {
    setTab('execution');
    if (state.runStatus === 'idle' || state.runStatus === 'completed') startRun();
}

function startRun() {
    state.currentRun = 'run_' + new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
    state.runStatus = 'executing';
    state.runProgress = 0;
    state.completedJobs = [];
    state.logs = [];

    document.getElementById('run-indicator').classList.remove('hidden');
    document.getElementById('run-indicator').classList.add('flex');

    addLog('INFO', 'Run gestartet: ' + state.currentRun);
    addLog('INFO', 'Parsing YAML configuration...');
    render();

    setTimeout(function() {
        addLog('SUCCESS', 'Configuration validated');
        state.runProgress = 5;
        render();
        executeJobs(0);
    }, 1000);
}

function executeJobs(idx) {
    if (idx >= executionPlan.jobs.length) { finishRun(); return; }
    var job = executionPlan.jobs[idx];
    state.currentJob = job.name;
    addLog('INFO', 'Starting: ' + job.name);
    render();

    setTimeout(function() {
        state.completedJobs.push(job.id);
        state.runProgress = 5 + Math.round((idx + 1) / executionPlan.jobs.length * 90);
        addLog('SUCCESS', 'Completed: ' + job.name);
        render();
        setTimeout(function() { executeJobs(idx + 1); }, 200);
    }, job.duration);
}

function finishRun() {
    state.runStatus = 'completed';
    state.runProgress = 100;
    state.currentJob = null;
    addLog('SUCCESS', '═══════════════════════════════════════');
    addLog('SUCCESS', 'Run erfolgreich abgeschlossen!');
    addLog('INFO', 'Jobs: 15/15 • Duration: 42s • Savings: 67%');
    document.getElementById('run-indicator-text').textContent = 'Abgeschlossen';
    render();
}

function stopRun() { state.runStatus = 'failed'; addLog('ERROR', 'Run gestoppt'); render(); }
function resetRun() { state.runStatus = 'idle'; state.runProgress = 0; state.completedJobs = []; state.logs = []; state.currentRun = null; document.getElementById('run-indicator').classList.add('hidden'); render(); }

function startMigration() {
    state.migrationPhase = 'running';
    state.migrationProgress = 0;
    state.migratedTables = [];
    render();

    function migrateNext(idx) {
        if (idx >= eccToS4Mappings.length) { state.migrationPhase = 'completed'; render(); return; }
        state.migratedTables.push(idx);
        state.migrationProgress = Math.round((idx + 1) / eccToS4Mappings.length * 100);
        render();
        setTimeout(function() { migrateNext(idx + 1); }, 800);
    }
    migrateNext(0);
}

function validateConfig() {
    var result = document.getElementById('validation-result');
    result.innerHTML = '<div class="p-3 rounded-lg bg-green-500/20 border border-green-500/30 flex items-center gap-2 text-green-400"><i data-lucide="check-circle" class="w-5 h-5"></i><span>Konfiguration ist valide!</span></div>';
    lucide.createIcons();
}

// Templates & Downloads
function downloadTemplate(id) {
    var t = excelTemplates.find(function(x) { return x.id === id; });
    if (!t) return;
    var wb = XLSX.utils.book_new();
    var data = [['ID', 'Name', 'Description']];
    for (var i = 1; i <= Math.min(t.rows, 10); i++) data.push([i, t.name + ' ' + i, 'Sample']);
    var ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, t.name);
    XLSX.writeFile(wb, 'SAP_Template_' + t.id + '.xlsx');
}

function downloadABAP(id) {
    var code = '*&---------------------------------------------------------------------*\n*& Report ' + id + '\n*&---------------------------------------------------------------------*\nREPORT ' + id + '.\n\n* Generated by SAP Implementation Factory\n* Project: ' + config.project.name + '\n\nSTART-OF-SELECTION.\n  WRITE: / \'SAP Factory Generated Code\'.\n';
    downloadFile(code, id + '.abap', 'text/plain');
}

function downloadAllABAP() { abapPrograms.forEach(function(p) { setTimeout(function() { downloadABAP(p.id); }, 100); }); }

function downloadTransport() {
    var content = 'Transport Request: DEVK900001\nGenerated: ' + new Date().toISOString() + '\nProject: ' + config.project.name + '\n\nObjects:\n- TABL T001\n- PROG Z_FACTORY_*\n- CLAS ZCL_FACTORY_*\n';
    downloadFile(content, 'DEVK900001.txt', 'text/plain');
}

function downloadDoc(id) {
    // Create comprehensive DOCX documents using docx library
    var docxLib = window.docx;
    var dateStr = new Date().toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric' });

    var docConfig = {
        impl_guide: createImplementationGuide(docxLib, dateStr),
        config_doc: createConfigurationDoc(docxLib, dateStr),
        test_report: createTestReport(docxLib, dateStr),
        migration_log: createMigrationLog(docxLib, dateStr),
        recon_report: createReconciliationReport(docxLib, dateStr)
    };

    var doc = docConfig[id];
    if (!doc) {
        console.error('Unknown document type:', id);
        return;
    }

    docxLib.Packer.toBlob(doc).then(function(blob) {
        saveAs(blob, 'SAP_Factory_' + id + '.docx');
    });
}

function createImplementationGuide(docxLib, dateStr) {
    var D = docxLib;
    return new D.Document({
        styles: {
            default: { document: { run: { font: 'Arial', size: 24 } } },
            paragraphStyles: [
                { id: 'Heading1', name: 'Heading 1', basedOn: 'Normal', next: 'Normal', quickFormat: true,
                  run: { size: 32, bold: true, font: 'Arial', color: '1F4E79' },
                  paragraph: { spacing: { before: 400, after: 200 }, outlineLevel: 0 } },
                { id: 'Heading2', name: 'Heading 2', basedOn: 'Normal', next: 'Normal', quickFormat: true,
                  run: { size: 28, bold: true, font: 'Arial', color: '2E75B6' },
                  paragraph: { spacing: { before: 300, after: 150 }, outlineLevel: 1 } },
                { id: 'Heading3', name: 'Heading 3', basedOn: 'Normal', next: 'Normal', quickFormat: true,
                  run: { size: 24, bold: true, font: 'Arial' },
                  paragraph: { spacing: { before: 200, after: 100 }, outlineLevel: 2 } }
            ]
        },
        numbering: {
            config: [{
                reference: 'bullets',
                levels: [{ level: 0, format: D.LevelFormat.BULLET, text: '\u2022', alignment: D.AlignmentType.LEFT,
                    style: { paragraph: { indent: { left: 720, hanging: 360 } } } }]
            }, {
                reference: 'numbers',
                levels: [{ level: 0, format: D.LevelFormat.DECIMAL, text: '%1.', alignment: D.AlignmentType.LEFT,
                    style: { paragraph: { indent: { left: 720, hanging: 360 } } } }]
            }]
        },
        sections: [{
            properties: {
                page: { size: { width: 11906, height: 16838 }, margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } }
            },
            headers: {
                default: new D.Header({ children: [
                    new D.Paragraph({ children: [
                        new D.TextRun({ text: 'SAP Implementation Factory - ' + config.project.name, size: 18, color: '666666' })
                    ], alignment: D.AlignmentType.RIGHT })
                ]})
            },
            footers: {
                default: new D.Footer({ children: [
                    new D.Paragraph({ children: [
                        new D.TextRun({ text: 'Seite ', size: 18, color: '666666' }),
                        new D.TextRun({ children: [D.PageNumber.CURRENT], size: 18, color: '666666' }),
                        new D.TextRun({ text: ' von ', size: 18, color: '666666' }),
                        new D.TextRun({ children: [D.PageNumber.TOTAL_PAGES], size: 18, color: '666666' })
                    ], alignment: D.AlignmentType.CENTER })
                ]})
            },
            children: [
                // Title Page
                new D.Paragraph({ children: [] }),
                new D.Paragraph({ children: [] }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'SAP S/4HANA', bold: true, size: 72, color: '1F4E79' })
                ], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'Implementation Guide', bold: true, size: 56, color: '2E75B6' })
                ], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [] }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: config.project.name, bold: true, size: 36 })
                ], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [] }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'Erstellt am: ' + dateStr, size: 24, color: '666666' })
                ], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'Version 1.0', size: 24, color: '666666' })
                ], alignment: D.AlignmentType.CENTER }),

                // Page Break
                new D.Paragraph({ children: [new D.PageBreak()] }),

                // Table of Contents
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('Inhaltsverzeichnis')] }),
                new D.TableOfContents('Inhaltsverzeichnis', { hyperlink: true, headingStyleRange: '1-3' }),

                new D.Paragraph({ children: [new D.PageBreak()] }),

                // Chapter 1: Executive Summary
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('1. Executive Summary')] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Dieses Dokument beschreibt die vollautomatisierte S/4HANA-Implementierung für ' + config.project.name + '. Die SAP Implementation Factory ermöglicht eine 100% automatisierte Durchführung aller Customizing-, Migrations- und Testaktivitäten.')
                ], spacing: { after: 200 } }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'Projektkennzahlen:', bold: true })
                ], spacing: { after: 100 } }),
                new D.Paragraph({ numbering: { reference: 'bullets', level: 0 }, children: [
                    new D.TextRun('Automatisierungsgrad: 100%')
                ] }),
                new D.Paragraph({ numbering: { reference: 'bullets', level: 0 }, children: [
                    new D.TextRun('Kostenersparnis: 67% gegenüber klassischer Implementierung')
                ] }),
                new D.Paragraph({ numbering: { reference: 'bullets', level: 0 }, children: [
                    new D.TextRun('Zeitersparnis: 85 Stunden pro Implementierungsphase')
                ] }),
                new D.Paragraph({ numbering: { reference: 'bullets', level: 0 }, children: [
                    new D.TextRun('First-Time-Right Rate: 99,2%')
                ] }),

                // Chapter 2: Scope
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('2. Implementierungsumfang')] }),

                new D.Paragraph({ heading: D.HeadingLevel.HEADING_2, children: [new D.TextRun('2.1 Module')] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Die Implementierung umfasst folgende SAP-Module:')
                ], spacing: { after: 200 } }),

                createModuleTable(D),

                new D.Paragraph({ heading: D.HeadingLevel.HEADING_2, children: [new D.TextRun('2.2 Organisationsstruktur')] }),
                createOrgStructureTable(D),

                // Chapter 3: Technical Architecture
                new D.Paragraph({ children: [new D.PageBreak()] }),
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('3. Technische Architektur')] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Die SAP Implementation Factory basiert auf einer modernen, plugin-basierten Architektur:')
                ], spacing: { after: 200 } }),

                new D.Paragraph({ heading: D.HeadingLevel.HEADING_2, children: [new D.TextRun('3.1 Komponenten')] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Parser: ', bold: true }), new D.TextRun('Verarbeitet YAML-Konfigurationsdateien und erstellt das Domain Model')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Planner: ', bold: true }), new D.TextRun('Generiert den optimalen Execution Plan basierend auf Abhängigkeiten')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Executor: ', bold: true }), new D.TextRun('Führt Jobs parallel aus und überwacht den Fortschritt')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Plugins: ', bold: true }), new D.TextRun('CustomizingPlugin, MigrationPlugin, TestingPlugin')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Systeme: ', bold: true }), new D.TextRun('Source (ECC 6.0) → Target (S/4HANA 2023)')
                ] }),

                // Chapter 4: Migration
                new D.Paragraph({ children: [new D.PageBreak()] }),
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('4. Datenmigration')] }),
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_2, children: [new D.TextRun('4.1 Business Partner Migration (CVI)')] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Die Migration von Kunden und Lieferanten erfolgt über das Customer-Vendor Integration (CVI) Framework. Dabei werden die klassischen KNA1/LFA1-Strukturen in das neue Business Partner Datenmodell überführt.')
                ], spacing: { after: 200 } }),

                createMigrationTable(D),

                // Chapter 5: Timeline
                new D.Paragraph({ children: [new D.PageBreak()] }),
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('5. Projektplan')] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Der automatisierte Implementierungsprozess folgt einem strukturierten Phasenmodell:')
                ], spacing: { after: 200 } }),

                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Phase 1 - Vorbereitung (1 Tag): ', bold: true }), new D.TextRun('YAML-Konfiguration, Template-Upload')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Phase 2 - Customizing (2 Tage): ', bold: true }), new D.TextRun('Automatische FI/CO/MM/SD Konfiguration')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Phase 3 - Migration (3 Tage): ', bold: true }), new D.TextRun('Stammdaten- und Bewegungsdatenmigration')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Phase 4 - Testing (2 Tage): ', bold: true }), new D.TextRun('Automatisierte Prozess- und API-Tests')
                ] }),
                new D.Paragraph({ numbering: { reference: 'numbers', level: 0 }, children: [
                    new D.TextRun({ text: 'Phase 5 - Go-Live (1 Tag): ', bold: true }), new D.TextRun('Produktivsetzung und Monitoring')
                ] }),

                // Final Page
                new D.Paragraph({ children: [new D.PageBreak()] }),
                new D.Paragraph({ heading: D.HeadingLevel.HEADING_1, children: [new D.TextRun('6. Kontakt')] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Bei Fragen zur SAP Implementation Factory wenden Sie sich an Ihr Projektteam.')
                ], spacing: { after: 200 } }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'SAP Implementation Factory', bold: true })
                ] }),
                new D.Paragraph({ children: [
                    new D.TextRun('Automatisierte S/4HANA Implementierung')
                ] }),
                new D.Paragraph({ children: [
                    new D.TextRun({ text: 'Generiert: ' + dateStr, italics: true, color: '666666' })
                ] })
            ]
        }]
    });
}

function createModuleTable(D) {
    var border = { style: D.BorderStyle.SINGLE, size: 1, color: 'CCCCCC' };
    var borders = { top: border, bottom: border, left: border, right: border };

    return new D.Table({
        width: { size: 100, type: D.WidthType.PERCENTAGE },
        columnWidths: [1500, 3000, 4500],
        rows: [
            new D.TableRow({
                children: [
                    new D.TableCell({ borders: borders, shading: { fill: '1F4E79', type: D.ShadingType.CLEAR },
                        children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Modul', bold: true, color: 'FFFFFF' })]})] }),
                    new D.TableCell({ borders: borders, shading: { fill: '1F4E79', type: D.ShadingType.CLEAR },
                        children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Bezeichnung', bold: true, color: 'FFFFFF' })]})] }),
                    new D.TableCell({ borders: borders, shading: { fill: '1F4E79', type: D.ShadingType.CLEAR },
                        children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Umfang', bold: true, color: 'FFFFFF' })]})] })
                ]
            }),
            new D.TableRow({ children: [
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun({ text: 'FI', bold: true })]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun('Financial Accounting')]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(config.fi.company_codes.length + ' Buchungskreise, ' + config.fi.gl_accounts + ' Sachkonten')]})] })
            ]}),
            new D.TableRow({ children: [
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun({ text: 'CO', bold: true })]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun('Controlling')]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(config.co.cost_centers + ' Kostenstellen, ' + config.co.profit_centers + ' Profit Center')]})] })
            ]}),
            new D.TableRow({ children: [
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun({ text: 'MM', bold: true })]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun('Materials Management')]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(config.mm.plants + ' Werke, ' + config.mm.materials + ' Materialien')]})] })
            ]}),
            new D.TableRow({ children: [
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun({ text: 'SD', bold: true })]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun('Sales & Distribution')]})] }),
                new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(config.sd.sales_orgs + ' Vertriebsorg., ' + config.sd.customers + ' Kunden')]})] })
            ]})
        ]
    });
}

function createOrgStructureTable(D) {
    var border = { style: D.BorderStyle.SINGLE, size: 1, color: 'CCCCCC' };
    var borders = { top: border, bottom: border, left: border, right: border };

    var rows = [
        new D.TableRow({
            children: [
                new D.TableCell({ borders: borders, shading: { fill: '2E75B6', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Buchungskreis', bold: true, color: 'FFFFFF' })]})] }),
                new D.TableCell({ borders: borders, shading: { fill: '2E75B6', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Bezeichnung', bold: true, color: 'FFFFFF' })]})] }),
                new D.TableCell({ borders: borders, shading: { fill: '2E75B6', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Währung', bold: true, color: 'FFFFFF' })]})] }),
                new D.TableCell({ borders: borders, shading: { fill: '2E75B6', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Land', bold: true, color: 'FFFFFF' })]})] })
            ]
        })
    ];

    for (var i = 0; i < config.fi.company_codes.length; i++) {
        var cc = config.fi.company_codes[i];
        rows.push(new D.TableRow({ children: [
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(cc.code)]})] }),
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(cc.name)]})] }),
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(cc.currency)]})] }),
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(cc.country)]})] })
        ]}));
    }

    return new D.Table({
        width: { size: 100, type: D.WidthType.PERCENTAGE },
        columnWidths: [2000, 4000, 1500, 1500],
        rows: rows
    });
}

function createMigrationTable(D) {
    var border = { style: D.BorderStyle.SINGLE, size: 1, color: 'CCCCCC' };
    var borders = { top: border, bottom: border, left: border, right: border };

    var rows = [
        new D.TableRow({
            children: [
                new D.TableCell({ borders: borders, shading: { fill: 'D35400', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'ECC Tabelle', bold: true, color: 'FFFFFF' })]})] }),
                new D.TableCell({ borders: borders, shading: { fill: '27AE60', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'S/4HANA Tabelle', bold: true, color: 'FFFFFF' })]})] }),
                new D.TableCell({ borders: borders, shading: { fill: '2980B9', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Beschreibung', bold: true, color: 'FFFFFF' })]})] }),
                new D.TableCell({ borders: borders, shading: { fill: '8E44AD', type: D.ShadingType.CLEAR },
                    children: [new D.Paragraph({ children: [new D.TextRun({ text: 'Datensätze', bold: true, color: 'FFFFFF' })]})] })
            ]
        })
    ];

    for (var i = 0; i < eccToS4Mappings.length; i++) {
        var m = eccToS4Mappings[i];
        rows.push(new D.TableRow({ children: [
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun({ text: m.ecc, font: 'Consolas', size: 20 })]})] }),
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun({ text: m.s4, font: 'Consolas', size: 20 })]})] }),
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(m.desc)]})] }),
            new D.TableCell({ borders: borders, children: [new D.Paragraph({ children: [new D.TextRun(m.records.toLocaleString())], alignment: D.AlignmentType.RIGHT })] })
        ]}));
    }

    return new D.Table({
        width: { size: 100, type: D.WidthType.PERCENTAGE },
        columnWidths: [2200, 2200, 3100, 1500],
        rows: rows
    });
}

function createConfigurationDoc(docxLib, dateStr) {
    var D = docxLib;
    return new D.Document({
        styles: { default: { document: { run: { font: 'Arial', size: 24 } } } },
        sections: [{
            properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } },
            children: [
                new D.Paragraph({ children: [new D.TextRun({ text: 'Configuration Documentation', bold: true, size: 48, color: '1F4E79' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: config.project.name, size: 32 })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: dateStr, color: '666666' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.PageBreak()] }),

                new D.Paragraph({ children: [new D.TextRun({ text: '1. Systemlandschaft', bold: true, size: 32 })] }),
                new D.Paragraph({ children: [new D.TextRun('Die Implementierung erfolgt in der folgenden Systemlandschaft:')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'DEV (Client 100)', bold: true }), new D.TextRun(' - Entwicklungssystem')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'QAS (Client 200)', bold: true }), new D.TextRun(' - Qualitätssicherung')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'PRD (Client 300)', bold: true }), new D.TextRun(' - Produktivsystem')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: '2. FI Customizing', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Folgende FI-Einstellungen wurden konfiguriert:')] }),
                new D.Paragraph({ children: [new D.TextRun('Buchungskreise: ' + config.fi.company_codes.length)] }),
                new D.Paragraph({ children: [new D.TextRun('Sachkonten: ' + config.fi.gl_accounts)] }),
                new D.Paragraph({ children: [new D.TextRun('Steuerkennzeichen: ' + config.fi.tax_codes)] }),
                new D.Paragraph({ children: [new D.TextRun('Zahlungsbedingungen: ' + config.fi.payment_terms)] }),
                new D.Paragraph({ children: [new D.TextRun('Hausbanken: ' + config.fi.house_banks)] }),

                new D.Paragraph({ children: [new D.TextRun({ text: '3. CO Customizing', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Kostenrechnungskreis: ' + config.co.controlling_area)] }),
                new D.Paragraph({ children: [new D.TextRun('Kostenstellen: ' + config.co.cost_centers)] }),
                new D.Paragraph({ children: [new D.TextRun('Profit Center: ' + config.co.profit_centers)] }),
                new D.Paragraph({ children: [new D.TextRun('Kostenarten: ' + config.co.cost_elements)] }),

                new D.Paragraph({ children: [new D.TextRun({ text: '4. MM Customizing', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Werke: ' + config.mm.plants)] }),
                new D.Paragraph({ children: [new D.TextRun('Lagerorte: ' + config.mm.storage_locations)] }),
                new D.Paragraph({ children: [new D.TextRun('Einkaufsorganisationen: ' + config.mm.purchasing_orgs)] }),

                new D.Paragraph({ children: [new D.TextRun({ text: '5. SD Customizing', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Vertriebsorganisationen: ' + config.sd.sales_orgs)] }),
                new D.Paragraph({ children: [new D.TextRun('Vertriebswege: ' + config.sd.distribution_channels)] }),
                new D.Paragraph({ children: [new D.TextRun('Sparten: ' + config.sd.divisions)] }),
                new D.Paragraph({ children: [new D.TextRun('Konditionsarten: ' + config.sd.condition_types)] })
            ]
        }]
    });
}

function createTestReport(docxLib, dateStr) {
    var D = docxLib;
    return new D.Document({
        styles: { default: { document: { run: { font: 'Arial', size: 24 } } } },
        sections: [{
            properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } },
            children: [
                new D.Paragraph({ children: [new D.TextRun({ text: 'Test Execution Report', bold: true, size: 48, color: '27AE60' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: config.project.name, size: 32 })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: dateStr, color: '666666' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.PageBreak()] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Testergebnisse Zusammenfassung', bold: true, size: 32 })] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Alle Tests erfolgreich bestanden!', color: '27AE60', bold: true, size: 28 })] }),
                new D.Paragraph({ children: [] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'API Tests', bold: true, size: 28 })] }),
                new D.Paragraph({ children: [new D.TextRun('Testfälle: 8 | Bestanden: 8 | Fehlgeschlagen: 0')] }),
                new D.Paragraph({ children: [new D.TextRun('Erfolgsrate: 100%')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'BAPI Tests', bold: true, size: 28 })], spacing: { before: 300 } }),
                new D.Paragraph({ children: [new D.TextRun('Testfälle: 12 | Bestanden: 12 | Fehlgeschlagen: 0')] }),
                new D.Paragraph({ children: [new D.TextRun('Erfolgsrate: 100%')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'P2P Prozess Tests', bold: true, size: 28 })], spacing: { before: 300 } }),
                new D.Paragraph({ children: [new D.TextRun('Testfälle: 6 | Bestanden: 6 | Fehlgeschlagen: 0')] }),
                new D.Paragraph({ children: [new D.TextRun('Getestete Szenarien: Bestellanforderung, Bestellung, Wareneingang, Rechnungseingang')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'O2C Prozess Tests', bold: true, size: 28 })], spacing: { before: 300 } }),
                new D.Paragraph({ children: [new D.TextRun('Testfälle: 8 | Bestanden: 8 | Fehlgeschlagen: 0')] }),
                new D.Paragraph({ children: [new D.TextRun('Getestete Szenarien: Kundenauftrag, Lieferung, Faktura, Zahlung')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'R2R Prozess Tests', bold: true, size: 28 })], spacing: { before: 300 } }),
                new D.Paragraph({ children: [new D.TextRun('Testfälle: 5 | Bestanden: 5 | Fehlgeschlagen: 0')] }),
                new D.Paragraph({ children: [new D.TextRun('Getestete Szenarien: Buchung, Abstimmung, Periodenabschluss')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Gesamtergebnis', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Gesamt-Testfälle: 39')] }),
                new D.Paragraph({ children: [new D.TextRun('Bestanden: 39')] }),
                new D.Paragraph({ children: [new D.TextRun('Fehlgeschlagen: 0')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Gesamt-Erfolgsrate: 100%', bold: true, color: '27AE60', size: 28 })] })
            ]
        }]
    });
}

function createMigrationLog(docxLib, dateStr) {
    var D = docxLib;
    return new D.Document({
        styles: { default: { document: { run: { font: 'Arial', size: 24 } } } },
        sections: [{
            properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } },
            children: [
                new D.Paragraph({ children: [new D.TextRun({ text: 'Migration Protocol', bold: true, size: 48, color: 'D35400' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: config.project.name, size: 32 })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: dateStr, color: '666666' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.PageBreak()] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Migrationsübersicht', bold: true, size: 32 })] }),
                new D.Paragraph({ children: [new D.TextRun('Quellsystem: ECC 6.0')] }),
                new D.Paragraph({ children: [new D.TextRun('Zielsystem: S/4HANA 2023')] }),
                new D.Paragraph({ children: [new D.TextRun('Migrationsmethode: CVI Business Partner + Universal Journal')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Business Partner Migration', bold: true, size: 28 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Kunden migriert: ' + config.sd.customers)] }),
                new D.Paragraph({ children: [new D.TextRun('Lieferanten migriert: ' + config.mm.vendors)] }),
                new D.Paragraph({ children: [new D.TextRun('Gesamt Business Partner: ' + (config.sd.customers + config.mm.vendors))] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Status: Erfolgreich', color: '27AE60', bold: true })] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Materialstamm Migration', bold: true, size: 28 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Materialien migriert: ' + config.mm.materials)] }),
                new D.Paragraph({ children: [new D.TextRun('Werke: ' + config.mm.plants)] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Status: Erfolgreich', color: '27AE60', bold: true })] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'FI Daten Migration', bold: true, size: 28 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('FI Belege transformiert: 125.000')] }),
                new D.Paragraph({ children: [new D.TextRun('CO Belege transformiert: 45.000')] }),
                new D.Paragraph({ children: [new D.TextRun('Material Ledger Belege: 8.500')] }),
                new D.Paragraph({ children: [new D.TextRun('Ziel: Universal Journal (ACDOCA)')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Status: Erfolgreich', color: '27AE60', bold: true })] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Migrationsstatistik', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Gesamtdauer: 4 Stunden 23 Minuten')] }),
                new D.Paragraph({ children: [new D.TextRun('Datensätze gesamt: 211.630')] }),
                new D.Paragraph({ children: [new D.TextRun('Fehlerquote: 0%')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Migration erfolgreich abgeschlossen!', bold: true, color: '27AE60', size: 28 })] })
            ]
        }]
    });
}

function createReconciliationReport(docxLib, dateStr) {
    var D = docxLib;
    return new D.Document({
        styles: { default: { document: { run: { font: 'Arial', size: 24 } } } },
        sections: [{
            properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } },
            children: [
                new D.Paragraph({ children: [new D.TextRun({ text: 'Reconciliation Report', bold: true, size: 48, color: '8E44AD' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: config.project.name, size: 32 })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.TextRun({ text: dateStr, color: '666666' })], alignment: D.AlignmentType.CENTER }),
                new D.Paragraph({ children: [new D.PageBreak()] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Abstimmungsergebnis', bold: true, size: 32 })] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'ALLE DATEN ERFOLGREICH ABGESTIMMT', color: '27AE60', bold: true, size: 28 })] }),
                new D.Paragraph({ children: [] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Stammdaten Reconciliation', bold: true, size: 28 })] }),
                new D.Paragraph({ children: [new D.TextRun('Kunden: Quellsystem ' + config.sd.customers + ' = Zielsystem ' + config.sd.customers + ' ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('Lieferanten: Quellsystem ' + config.mm.vendors + ' = Zielsystem ' + config.mm.vendors + ' ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('Materialien: Quellsystem ' + config.mm.materials + ' = Zielsystem ' + config.mm.materials + ' ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('Sachkonten: Quellsystem ' + config.fi.gl_accounts + ' = Zielsystem ' + config.fi.gl_accounts + ' ✓')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Bewegungsdaten Reconciliation', bold: true, size: 28 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('FI Belege: 125.000 = 125.000 ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('CO Belege: 45.000 = 45.000 ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('SD Belege: 32.000 = 32.000 ✓')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Salden Reconciliation', bold: true, size: 28 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Kreditorensalden: Abgestimmt ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('Debitorensalden: Abgestimmt ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('Sachkontensalden: Abgestimmt ✓')] }),
                new D.Paragraph({ children: [new D.TextRun('Bestandswerte: Abgestimmt ✓')] }),

                new D.Paragraph({ children: [new D.TextRun({ text: 'Fazit', bold: true, size: 32 })], spacing: { before: 400 } }),
                new D.Paragraph({ children: [new D.TextRun('Die vollständige Abstimmung zwischen Quell- und Zielsystem wurde erfolgreich durchgeführt. Alle Stamm- und Bewegungsdaten sowie sämtliche Salden stimmen überein. Das System ist für den Produktivbetrieb freigegeben.')] }),
                new D.Paragraph({ children: [new D.TextRun({ text: 'Match Rate: 100%', bold: true, color: '27AE60', size: 28 })] })
            ]
        }]
    });
}

function downloadAllDocs() {
    var docs = ['impl_guide', 'config_doc', 'test_report', 'migration_log', 'recon_report'];
    var delay = 0;
    docs.forEach(function(d) {
        setTimeout(function() { downloadDoc(d); }, delay);
        delay += 1000; // 1 second delay between downloads
    });
}

function downloadFile(content, filename, mime) {
    var blob = new Blob([content], { type: mime });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

function testAPI() {
    var method = document.getElementById('api-method').value;
    var path = document.getElementById('api-path').value;
    var response = { status: 200, data: { runs: [{ run_id: 'demo', status: 'completed' }] } };
    document.getElementById('api-response').innerHTML = '<pre>' + formatJSON(response) + '</pre>';
}

function setEndpoint(method, path) {
    document.getElementById('api-method').value = method;
    document.getElementById('api-path').value = path;
}

function setupEventListeners() {
    var fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.onchange = function(e) {
            processMultipleFiles(e.target.files);
        };
    }

    var zone = document.getElementById('upload-zone');
    if (zone) {
        zone.ondragover = function(e) { e.preventDefault(); zone.classList.add('dragover'); };
        zone.ondragleave = function() { zone.classList.remove('dragover'); };
        zone.ondrop = function(e) {
            e.preventDefault();
            zone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                processMultipleFiles(e.dataTransfer.files);
            }
        };
    }
}

function processMultipleFiles(files) {
    var fileArray = Array.prototype.slice.call(files);

    fileArray.forEach(function(file) {
        var reader = new FileReader();
        reader.onload = function(ev) {
            try {
                var wb = XLSX.read(ev.target.result, { type: 'binary' });
                var ws = wb.Sheets[wb.SheetNames[0]];
                var data = XLSX.utils.sheet_to_json(ws);
                var headers = data.length > 0 ? Object.keys(data[0]) : [];

                // Detect file type based on headers or filename
                var detectedType = detectFileType(file.name, headers);

                // Create file info object
                var fileInfo = {
                    name: file.name,
                    rows: data.length,
                    headers: headers,
                    type: detectedType.type,
                    detectedType: detectedType.label,
                    data: data
                };

                // Add to uploaded files (avoid duplicates)
                var exists = state.uploadedFiles.some(function(f) { return f.name === file.name; });
                if (!exists) {
                    state.uploadedFiles.push(fileInfo);
                }

                // Extract project name from company_codes or first suitable file
                if (detectedType.type === 'company_codes' || !config.project.name || config.project.name === 'Mustermann GmbH') {
                    if (data[0] && (data[0].NAME || data[0].Name || data[0].BUTXT || data[0].Firma || data[0].Company)) {
                        config.project.name = data[0].NAME || data[0].Name || data[0].BUTXT || data[0].Firma || data[0].Company;
                        var projNameEl = document.getElementById('project-name');
                        if (projNameEl) projNameEl.textContent = config.project.name;
                    }
                }

                // Update config based on file type
                updateConfigFromFile(detectedType.type, data);

                render();
            } catch (err) {
                console.error('Error processing file:', file.name, err);
                // Still add the file even if parsing fails
                var fileInfo = {
                    name: file.name,
                    rows: 0,
                    headers: [],
                    type: 'unknown',
                    detectedType: 'Unbekannt',
                    data: []
                };
                var exists = state.uploadedFiles.some(function(f) { return f.name === file.name; });
                if (!exists) {
                    state.uploadedFiles.push(fileInfo);
                }
                render();
            }
        };
        reader.readAsBinaryString(file);
    });
}

function detectFileType(filename, headers) {
    var fn = filename.toLowerCase();
    var h = headers.join(' ').toLowerCase();

    // Check filename patterns
    if (fn.indexOf('buchungskreis') !== -1 || fn.indexOf('company') !== -1 || fn.indexOf('bukrs') !== -1) {
        return { type: 'company_codes', label: 'Buchungskreise' };
    }
    if (fn.indexOf('sachkont') !== -1 || fn.indexOf('gl_account') !== -1 || fn.indexOf('hkont') !== -1) {
        return { type: 'gl_accounts', label: 'Sachkonten' };
    }
    if (fn.indexOf('kostenstell') !== -1 || fn.indexOf('cost_center') !== -1 || fn.indexOf('kostl') !== -1) {
        return { type: 'cost_centers', label: 'Kostenstellen' };
    }
    if (fn.indexOf('profit') !== -1 || fn.indexOf('prctr') !== -1) {
        return { type: 'profit_centers', label: 'Profit Center' };
    }
    if (fn.indexOf('material') !== -1 || fn.indexOf('matnr') !== -1) {
        return { type: 'materials', label: 'Materialstamm' };
    }
    if (fn.indexOf('lieferant') !== -1 || fn.indexOf('vendor') !== -1 || fn.indexOf('lifnr') !== -1) {
        return { type: 'vendors', label: 'Lieferanten' };
    }
    if (fn.indexOf('kunde') !== -1 || fn.indexOf('customer') !== -1 || fn.indexOf('kunnr') !== -1) {
        return { type: 'customers', label: 'Kunden' };
    }
    if (fn.indexOf('werk') !== -1 || fn.indexOf('plant') !== -1 || fn.indexOf('werks') !== -1) {
        return { type: 'plants', label: 'Werke' };
    }

    // Check headers
    if (h.indexOf('bukrs') !== -1 || h.indexOf('butxt') !== -1 || h.indexOf('company_code') !== -1) {
        return { type: 'company_codes', label: 'Buchungskreise' };
    }
    if (h.indexOf('hkont') !== -1 || h.indexOf('saknr') !== -1 || h.indexOf('gl_account') !== -1) {
        return { type: 'gl_accounts', label: 'Sachkonten' };
    }
    if (h.indexOf('kostl') !== -1 || h.indexOf('cost_center') !== -1) {
        return { type: 'cost_centers', label: 'Kostenstellen' };
    }
    if (h.indexOf('matnr') !== -1 || h.indexOf('material') !== -1) {
        return { type: 'materials', label: 'Materialstamm' };
    }
    if (h.indexOf('lifnr') !== -1 || h.indexOf('vendor') !== -1) {
        return { type: 'vendors', label: 'Lieferanten' };
    }
    if (h.indexOf('kunnr') !== -1 || h.indexOf('customer') !== -1) {
        return { type: 'customers', label: 'Kunden' };
    }

    return { type: 'data', label: 'Daten' };
}

function updateConfigFromFile(fileType, data) {
    var rowCount = data.length;

    switch (fileType) {
        case 'company_codes':
            config.fi.company_codes = data.map(function(row) {
                return {
                    code: row.BUKRS || row.Code || row.code || String(row.ID || ''),
                    name: row.BUTXT || row.NAME || row.Name || row.Firma || '',
                    currency: row.WAERS || row.Currency || 'EUR',
                    country: row.LAND1 || row.Country || 'DE'
                };
            });
            break;
        case 'gl_accounts':
            config.fi.gl_accounts = rowCount;
            break;
        case 'cost_centers':
            config.co.cost_centers = rowCount;
            break;
        case 'profit_centers':
            config.co.profit_centers = rowCount;
            break;
        case 'plants':
            config.mm.plants = rowCount;
            break;
        case 'materials':
            config.mm.materials = rowCount;
            break;
        case 'vendors':
            config.mm.vendors = rowCount;
            break;
        case 'customers':
            config.sd.customers = rowCount;
            break;
        case 'sales_orgs':
            config.sd.sales_orgs = rowCount;
            break;
        case 'conditions':
            config.sd.condition_types = rowCount;
            break;
    }
}

function removeUploadedFile(index) {
    state.uploadedFiles.splice(index, 1);
    recalculateConfigFromFiles();
    render();
}

function clearUploadedFiles() {
    state.uploadedFiles = [];
    resetConfigToDefaults();
    render();
}

function recalculateConfigFromFiles() {
    // Reset to defaults first
    resetConfigToDefaults();
    // Then recalculate from remaining files
    for (var i = 0; i < state.uploadedFiles.length; i++) {
        var f = state.uploadedFiles[i];
        if (f.data && f.data.length > 0) {
            updateConfigFromFile(f.type, f.data);
        }
    }
}

function resetConfigToDefaults() {
    config.fi.company_codes = [
        { code: '1000', name: config.project.name || 'Hauptsitz', currency: 'EUR', country: 'DE' }
    ];
    config.fi.gl_accounts = 0;
    config.co.cost_centers = 0;
    config.co.profit_centers = 0;
    config.mm.plants = 0;
    config.mm.materials = 0;
    config.mm.vendors = 0;
    config.sd.customers = 0;
    config.sd.sales_orgs = 0;
    config.sd.condition_types = 0;
}

// ==========================================
// BOT FUNCTIONS
// ==========================================

function toggleBotPanel() {
    state.botOpen = !state.botOpen;
    var panel = document.getElementById('bot-panel');
    if (state.botOpen) {
        panel.classList.add('bot-panel-open');
        // Initialize icons in bot panel
        setTimeout(function() { lucide.createIcons(); }, 50);
        // Send greeting if first time
        if (state.botMessages.length === 0) {
            addBotMessage('bot', 'Hallo! 👋 Ich bin Ihr SAP Implementation Factory Assistent. Wie kann ich Ihnen helfen?');
            setTimeout(function() {
                renderBotQuickActions([
                    { label: '📊 Status anzeigen', action: 'status' },
                    { label: '📁 Dateien hochladen', action: 'upload' },
                    { label: '🚀 Migration starten', action: 'migrate' },
                    { label: '📄 Dokumente generieren', action: 'docs' }
                ]);
            }, 500);
        }
    } else {
        panel.classList.remove('bot-panel-open');
    }
}

function addBotMessage(sender, text, html) {
    state.botMessages.push({
        sender: sender,
        text: text,
        html: html || null,
        time: new Date()
    });
    renderBotMessages();
}

function renderBotMessages() {
    var container = document.getElementById('bot-messages');
    if (!container) return;

    var html = '';
    for (var i = 0; i < state.botMessages.length; i++) {
        var msg = state.botMessages[i];
        var isBot = msg.sender === 'bot';
        var time = msg.time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

        if (isBot) {
            html += '<div class="flex gap-3 animate-fade-in">';
            html += '<div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center flex-shrink-0">';
            html += '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>';
            html += '</div>';
            html += '<div class="flex-1">';
            html += '<div class="bg-slate-800/50 rounded-2xl rounded-tl-sm p-4 border border-slate-700/50">';
            html += msg.html ? msg.html : '<p class="text-slate-200">' + msg.text + '</p>';
            html += '</div>';
            html += '<span class="text-xs text-slate-500 mt-1 block">' + time + '</span>';
            html += '</div></div>';
        } else {
            html += '<div class="flex gap-3 justify-end animate-fade-in">';
            html += '<div class="flex-1 text-right">';
            html += '<div class="bg-blue-600/30 rounded-2xl rounded-tr-sm p-4 border border-blue-500/30 inline-block text-left max-w-[85%]">';
            html += '<p class="text-slate-200">' + msg.text + '</p>';
            html += '</div>';
            html += '<span class="text-xs text-slate-500 mt-1 block">' + time + '</span>';
            html += '</div>';
            html += '<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">';
            html += '<svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
            html += '</div></div>';
        }
    }

    // Add typing indicator if bot is typing
    if (state.botTyping) {
        html += '<div class="flex gap-3 animate-fade-in" id="typing-indicator">';
        html += '<div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center flex-shrink-0">';
        html += '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>';
        html += '</div>';
        html += '<div class="bg-slate-800/50 rounded-2xl rounded-tl-sm p-4 border border-slate-700/50">';
        html += '<div class="flex gap-1"><span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>';
        html += '<span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:0.1s"></span>';
        html += '<span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:0.2s"></span></div>';
        html += '</div></div>';
    }

    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
}

function renderBotQuickActions(actions) {
    var html = '<div class="flex flex-wrap gap-2 mt-2">';
    for (var i = 0; i < actions.length; i++) {
        var a = actions[i];
        html += '<button onclick="handleBotAction(\'' + a.action + '\')" class="px-3 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-sm text-slate-300 border border-slate-600/50 transition">' + a.label + '</button>';
    }
    html += '</div>';

    state.botMessages.push({
        sender: 'bot',
        text: '',
        html: html,
        time: new Date()
    });
    renderBotMessages();
}

function handleBotAction(action) {
    switch (action) {
        case 'status':
            showBotStatus();
            break;
        case 'upload':
            addBotMessage('user', 'Dateien hochladen');
            showBotUploadPrompt();
            break;
        case 'migrate':
            addBotMessage('user', 'Migration starten');
            startBotMigration();
            break;
        case 'docs':
            addBotMessage('user', 'Dokumente generieren');
            showBotDocOptions();
            break;
        case 'impl_guide':
            generateImplementationGuide();
            addBotMessage('bot', '✅ Implementierungsleitfaden wurde generiert und heruntergeladen.');
            break;
        case 'config_doc':
            generateConfigurationDoc();
            addBotMessage('bot', '✅ Konfigurationsdokumentation wurde generiert und heruntergeladen.');
            break;
        case 'test_report':
            generateTestReport();
            addBotMessage('bot', '✅ Testbericht wurde generiert und heruntergeladen.');
            break;
    }
}

function showBotStatus() {
    addBotMessage('user', 'Status anzeigen');
    state.botTyping = true;
    renderBotMessages();

    setTimeout(function() {
        state.botTyping = false;

        var filesCount = state.uploadedFiles.length;
        var totalRecords = state.uploadedFiles.reduce(function(sum, f) { return sum + f.rows; }, 0);

        var html = '<div class="space-y-3">';
        html += '<p class="text-slate-200 font-medium">📊 Aktueller Projektstatus:</p>';
        html += '<div class="bg-slate-900/50 rounded-lg p-3 space-y-2">';
        html += '<div class="flex justify-between"><span class="text-slate-400">Projekt:</span><span class="text-slate-200">' + config.project.name + '</span></div>';
        html += '<div class="flex justify-between"><span class="text-slate-400">Source:</span><span class="text-slate-200">' + config.project.source + '</span></div>';
        html += '<div class="flex justify-between"><span class="text-slate-400">Target:</span><span class="text-slate-200">' + config.project.target + '</span></div>';
        html += '<div class="flex justify-between"><span class="text-slate-400">Hochgeladene Dateien:</span><span class="text-slate-200">' + filesCount + '</span></div>';
        html += '<div class="flex justify-between"><span class="text-slate-400">Datensätze gesamt:</span><span class="text-slate-200">' + totalRecords.toLocaleString() + '</span></div>';
        html += '</div>';

        if (filesCount > 0) {
            html += '<p class="text-slate-400 text-sm mt-2">Hochgeladene Dateien:</p>';
            html += '<ul class="text-sm space-y-1">';
            for (var i = 0; i < state.uploadedFiles.length; i++) {
                var f = state.uploadedFiles[i];
                html += '<li class="text-slate-300">• ' + f.detectedType + ': ' + f.rows.toLocaleString() + ' Datensätze</li>';
            }
            html += '</ul>';
        }
        html += '</div>';

        addBotMessage('bot', '', html);
    }, 800);
}

function showBotUploadPrompt() {
    state.botTyping = true;
    renderBotMessages();

    setTimeout(function() {
        state.botTyping = false;

        var html = '<div class="space-y-3">';
        html += '<p class="text-slate-200">Sie können Excel-Dateien per Drag & Drop in den Upload-Bereich des Dashboards ziehen oder den Upload-Button verwenden.</p>';
        html += '<p class="text-slate-300 text-sm">Unterstützte Dateitypen:</p>';
        html += '<ul class="text-sm text-slate-400 space-y-1">';
        html += '<li>• Buchungskreise (BUKRS)</li>';
        html += '<li>• Sachkonten (HKONT)</li>';
        html += '<li>• Kostenstellen (KOSTL)</li>';
        html += '<li>• Materialstamm (MATNR)</li>';
        html += '<li>• Kunden & Lieferanten</li>';
        html += '</ul>';

        if (state.uploadedFiles.length > 0) {
            html += '<p class="text-green-400 mt-2">✓ ' + state.uploadedFiles.length + ' Datei(en) bereits hochgeladen</p>';
        }
        html += '</div>';

        addBotMessage('bot', '', html);
    }, 600);
}

function startBotMigration() {
    if (state.uploadedFiles.length === 0) {
        state.botTyping = true;
        renderBotMessages();
        setTimeout(function() {
            state.botTyping = false;
            addBotMessage('bot', '⚠️ Bitte laden Sie zuerst Excel-Dateien hoch, bevor Sie die Migration starten können.');
            renderBotQuickActions([
                { label: '📁 Dateien hochladen', action: 'upload' }
            ]);
        }, 500);
        return;
    }

    state.botTyping = true;
    renderBotMessages();

    setTimeout(function() {
        state.botTyping = false;

        var totalRecords = state.uploadedFiles.reduce(function(sum, f) { return sum + f.rows; }, 0);

        var html = '<div class="space-y-3">';
        html += '<p class="text-slate-200">🚀 Migration wird gestartet...</p>';
        html += '<div class="bg-slate-900/50 rounded-lg p-3">';
        html += '<div class="flex justify-between mb-2"><span class="text-slate-400">Dateien:</span><span class="text-slate-200">' + state.uploadedFiles.length + '</span></div>';
        html += '<div class="flex justify-between"><span class="text-slate-400">Datensätze:</span><span class="text-slate-200">' + totalRecords.toLocaleString() + '</span></div>';
        html += '</div>';
        html += '<div class="w-full bg-slate-700 rounded-full h-2 mt-2">';
        html += '<div id="bot-progress-bar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>';
        html += '</div>';
        html += '<p id="bot-progress-text" class="text-sm text-slate-400">Initialisiere...</p>';
        html += '</div>';

        addBotMessage('bot', '', html);

        // Start migration simulation
        simulateBotMigration();
    }, 800);
}

function simulateBotMigration() {
    var progress = 0;
    var phases = [
        { p: 20, text: 'Validiere Quelldaten...' },
        { p: 40, text: 'Transformiere Datenstrukturen...' },
        { p: 60, text: 'Lade Daten in Zielsystem...' },
        { p: 80, text: 'Führe Qualitätsprüfungen durch...' },
        { p: 100, text: 'Migration abgeschlossen!' }
    ];
    var phase = 0;

    // Also start dashboard migration
    startMigration();

    var interval = setInterval(function() {
        if (phase < phases.length) {
            var bar = document.getElementById('bot-progress-bar');
            var text = document.getElementById('bot-progress-text');
            if (bar) bar.style.width = phases[phase].p + '%';
            if (text) text.textContent = phases[phase].text;
            phase++;
        } else {
            clearInterval(interval);
            setTimeout(function() {
                addBotMessage('bot', '✅ Migration erfolgreich abgeschlossen! Alle Daten wurden in das Zielsystem übertragen.');
                renderBotQuickActions([
                    { label: '📄 Migrationsbericht', action: 'migration_report' },
                    { label: '📊 Status anzeigen', action: 'status' }
                ]);
            }, 500);
        }
    }, 1200);
}

function showBotDocOptions() {
    state.botTyping = true;
    renderBotMessages();

    setTimeout(function() {
        state.botTyping = false;
        addBotMessage('bot', 'Welches Dokument möchten Sie generieren?');
        renderBotQuickActions([
            { label: '📘 Implementierungsleitfaden', action: 'impl_guide' },
            { label: '⚙️ Konfigurationsdoku', action: 'config_doc' },
            { label: '✅ Testbericht', action: 'test_report' }
        ]);
    }, 600);
}

function sendBotMessage() {
    var input = document.getElementById('bot-input');
    if (!input) return;

    var text = input.value.trim();
    if (!text) return;

    addBotMessage('user', text);
    input.value = '';

    // Process user message
    processBotUserMessage(text);
}

function processBotUserMessage(text) {
    var lower = text.toLowerCase();

    state.botTyping = true;
    renderBotMessages();

    setTimeout(function() {
        state.botTyping = false;

        // Simple intent detection
        if (lower.indexOf('status') !== -1 || lower.indexOf('stand') !== -1) {
            showBotStatus();
        } else if (lower.indexOf('upload') !== -1 || lower.indexOf('hochlad') !== -1 || lower.indexOf('datei') !== -1) {
            showBotUploadPrompt();
        } else if (lower.indexOf('migrat') !== -1 || lower.indexOf('start') !== -1) {
            startBotMigration();
        } else if (lower.indexOf('dokument') !== -1 || lower.indexOf('report') !== -1 || lower.indexOf('bericht') !== -1) {
            showBotDocOptions();
        } else if (lower.indexOf('hilfe') !== -1 || lower.indexOf('help') !== -1) {
            addBotMessage('bot', 'Ich kann Ihnen bei folgenden Aufgaben helfen:');
            renderBotQuickActions([
                { label: '📊 Status anzeigen', action: 'status' },
                { label: '📁 Dateien hochladen', action: 'upload' },
                { label: '🚀 Migration starten', action: 'migrate' },
                { label: '📄 Dokumente generieren', action: 'docs' }
            ]);
        } else {
            addBotMessage('bot', 'Ich habe Ihre Anfrage verstanden. Wie kann ich Ihnen weiterhelfen?');
            renderBotQuickActions([
                { label: '📊 Status', action: 'status' },
                { label: '🚀 Migration', action: 'migrate' },
                { label: '📄 Dokumente', action: 'docs' }
            ]);
        }
    }, 800);
}

// Handle Enter key in bot input
document.addEventListener('keydown', function(e) {
    if (e.target && e.target.id === 'bot-input' && e.key === 'Enter') {
        e.preventDefault();
        sendBotMessage();
    }
});

// ==========================================
// BOT FILE UPLOAD FUNCTIONS
// ==========================================

function handleBotFileUpload(event) {
    var files = event.target.files;
    if (files.length === 0) return;

    var fileList = [];
    for (var i = 0; i < files.length; i++) {
        fileList.push(files[i].name);
    }

    addBotMessage('user', '📎 ' + files.length + ' Datei(en) hochgeladen: ' + fileList.join(', '));

    state.botTyping = true;
    renderBotMessages();

    // Process files using existing function
    processBotFiles(files);

    // Reset input
    event.target.value = '';
}

function processBotFiles(files) {
    var filesArray = Array.prototype.slice.call(files);
    var processed = 0;
    var results = [];

    filesArray.forEach(function(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = e.target.result;
                var workbook = XLSX.read(data, { type: 'binary' });
                var firstSheet = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheet];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                var headers = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];

                var detectedType = detectFileType(file.name, headers);

                var fileInfo = {
                    name: file.name,
                    rows: jsonData.length,
                    headers: headers,
                    type: detectedType.type,
                    detectedType: detectedType.label,
                    data: jsonData
                };

                // Add to state if not exists
                var exists = state.uploadedFiles.some(function(f) { return f.name === file.name; });
                if (!exists) {
                    state.uploadedFiles.push(fileInfo);
                    updateConfigFromFile(detectedType.type, jsonData);
                }

                results.push({
                    name: file.name,
                    type: detectedType.label,
                    rows: jsonData.length,
                    success: true
                });

            } catch (err) {
                results.push({
                    name: file.name,
                    type: 'Fehler',
                    rows: 0,
                    success: false,
                    error: err.message
                });
            }

            processed++;
            if (processed === filesArray.length) {
                showBotUploadResults(results);
            }
        };
        reader.readAsBinaryString(file);
    });
}

function showBotUploadResults(results) {
    state.botTyping = false;

    var successCount = results.filter(function(r) { return r.success; }).length;
    var totalRows = results.reduce(function(sum, r) { return sum + r.rows; }, 0);

    var html = '<div class="space-y-3">';

    if (successCount === results.length) {
        html += '<p class="text-green-400 font-medium">✅ Alle Dateien erfolgreich verarbeitet!</p>';
    } else {
        html += '<p class="text-yellow-400 font-medium">⚠️ ' + successCount + ' von ' + results.length + ' Dateien verarbeitet</p>';
    }

    html += '<div class="bg-slate-900/50 rounded-lg p-3 space-y-2">';
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var icon = r.success ? '<span class="text-green-400">✓</span>' : '<span class="text-red-400">✗</span>';
        html += '<div class="flex justify-between items-center text-sm">';
        html += '<span class="text-slate-300">' + icon + ' ' + r.name + '</span>';
        html += '<span class="text-slate-400">' + r.type + ' (' + r.rows.toLocaleString() + ')</span>';
        html += '</div>';
    }
    html += '</div>';

    html += '<p class="text-slate-400 text-sm">Gesamt: ' + totalRows.toLocaleString() + ' Datensätze</p>';
    html += '</div>';

    addBotMessage('bot', '', html);

    // Update dashboard
    render();

    // Show next actions
    setTimeout(function() {
        renderBotQuickActions([
            { label: '📊 Status anzeigen', action: 'status' },
            { label: '🚀 Migration starten', action: 'migrate' },
            { label: '📁 Weitere Dateien', action: 'upload' }
        ]);
    }, 300);
}

// Setup Drag & Drop for Bot Panel
function setupBotDragDrop() {
    var panel = document.getElementById('bot-panel');
    var dropZone = document.getElementById('bot-drop-zone');
    var messagesArea = document.getElementById('bot-messages');

    if (!panel || !dropZone) return;

    // Prevent default drag behaviors on panel
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        panel.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    // Show drop zone on drag enter
    panel.addEventListener('dragenter', function(e) {
        if (e.dataTransfer.types.indexOf('Files') !== -1) {
            dropZone.classList.remove('hidden');
        }
    });

    // Hide drop zone when leaving panel
    panel.addEventListener('dragleave', function(e) {
        // Check if we're actually leaving the panel
        if (!panel.contains(e.relatedTarget)) {
            dropZone.classList.add('hidden');
        }
    });

    // Handle drop
    panel.addEventListener('drop', function(e) {
        dropZone.classList.add('hidden');

        var files = e.dataTransfer.files;
        if (files.length > 0) {
            // Filter for Excel files
            var excelFiles = [];
            for (var i = 0; i < files.length; i++) {
                var name = files[i].name.toLowerCase();
                if (name.endsWith('.xlsx') || name.endsWith('.xls') || name.endsWith('.csv')) {
                    excelFiles.push(files[i]);
                }
            }

            if (excelFiles.length > 0) {
                var fileList = excelFiles.map(function(f) { return f.name; });
                addBotMessage('user', '📎 ' + excelFiles.length + ' Datei(en) per Drag & Drop: ' + fileList.join(', '));
                state.botTyping = true;
                renderBotMessages();
                processBotFiles(excelFiles);
            } else {
                addBotMessage('bot', '⚠️ Bitte laden Sie Excel-Dateien (.xlsx, .xls, .csv) hoch.');
            }
        }
    });
}

// Init
document.addEventListener('DOMContentLoaded', function() {
    render();
    setupBotDragDrop();
});
</script>
</body>
</html>
